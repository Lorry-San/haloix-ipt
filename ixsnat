#!/bin/bash
###########################################
# SNAT + 策略路由 一体化配置脚本
# 功能：
# 1. 配置SNAT（ens20 -> ens18）
# 2. 远程配置策略路由（通过SSH）
# 3. IX端ens20网关指向本机ens20 IP
###########################################

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# 全局变量
INTERNAL_IF="ens20"  # 内网接口
EXTERNAL_IF="ens18"  # 外网接口
ALLOWED_IPS=()       # 允许转发的IP数组
LOCAL_ENS20_IP=""    # 本机ens20 IP（作为IX端的网关）

###########################################
# 工具函数
###########################################

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_debug() {
    echo -e "${BLUE}[DEBUG]${NC} $1"
}

log_step() {
    echo -e "${PURPLE}[STEP]${NC} $1"
}

print_header() {
    echo ""
    echo -e "${CYAN}=========================================${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}=========================================${NC}"
    echo ""
}

check_root() {
    if [ "$EUID" -ne 0 ]; then 
        log_error "请使用 root 权限运行此脚本"
        exit 1
    fi
}

check_interface() {
    if ! ip link show "$1" &> /dev/null; then
        log_error "网卡 $1 不存在"
        exit 1
    fi
    log_debug "网卡 $1 检查通过"
}

get_internal_network() {
    local network=$(ip -o -f inet addr show "$INTERNAL_IF" | awk '{print $4}')
    if [ -z "$network" ]; then
        log_error "无法从 $INTERNAL_IF 获取IP段"
        exit 1
    fi
    echo "$network"
}

get_internal_ip() {
    local ip=$(ip -o -f inet addr show "$INTERNAL_IF" | awk '{print $4}' | cut -d'/' -f1)
    if [ -z "$ip" ]; then
        log_error "无法从 $INTERNAL_IF 获取IP地址"
        exit 1
    fi
    echo "$ip"
}

get_external_ip() {
    local ip=$(ip -o -f inet addr show "$EXTERNAL_IF" | awk '{print $4}' | cut -d'/' -f1)
    if [ -z "$ip" ]; then
        log_error "无法从 $EXTERNAL_IF 获取公网IP"
        exit 1
    fi
    echo "$ip"
}

validate_ip() {
    local ip=$1
    # 支持单个IP和CIDR格式
    if [[ "$ip" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}(/[0-9]{1,2})?$ ]]; then
        return 0
    else
        return 1
    fi
}

save_iptables() {
    log_debug "保存 iptables 规则..."
    if command -v iptables-save &> /dev/null; then
        mkdir -p /etc/iptables
        iptables-save > /etc/iptables/rules.v4
        log_debug "规则已保存"
    else
        log_warn "未找到 iptables-save 命令，规则未持久化"
    fi
}

###########################################
# SNAT 配置函数
###########################################

init_snat() {
    log_step "初始化 SNAT 配置..."
    
    # 检查网卡
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    # 获取网络信息
    INTERNAL_NETWORK=$(get_internal_network)
    EXTERNAL_IP=$(get_external_ip)
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    log_info "内网网段: $INTERNAL_NETWORK"
    log_info "内网IP (ens20): $LOCAL_ENS20_IP"
    log_info "外网IP (ens18): $EXTERNAL_IP"
    
    # 启用IP转发
    log_debug "启用IP转发..."
    echo 1 > /proc/sys/net/ipv4/ip_forward
    
    # 永久生效
    if ! grep -q "^net.ipv4.ip_forward=1" /etc/sysctl.conf; then
        echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
        sysctl -p > /dev/null 2>&1
    fi
    
    # 清除现有的SNAT规则
    iptables -t nat -D POSTROUTING -s "$INTERNAL_NETWORK" -o "$EXTERNAL_IF" -j SNAT --to-source "$EXTERNAL_IP" 2>/dev/null
    
    # 设置FORWARD链默认策略
    log_debug "设置默认策略..."
    iptables -P FORWARD DROP
    
    # 清除旧的FORWARD规则
    iptables -D FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG 2>/dev/null
    iptables -D FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT 2>/dev/null
    
    # 允许已建立的连接
    if ! iptables -C FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 2>/dev/null; then
        log_debug "允许已建立和相关的连接..."
        iptables -I FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT
    fi
    
    # 添加允许转发的IP
    log_debug "配置允许转发的IP..."
    for ip in "${ALLOWED_IPS[@]}"; do
        add_allowed_ip "$ip" "silent"
    done
    
    # 拒绝其他所有转发请求
    log_debug "配置拒绝其他IP的转发..."
    if ! iptables -C FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG --log-prefix "FORWARD_REJECT: " 2>/dev/null; then
        iptables -A FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG --log-prefix "FORWARD_REJECT: " --log-level 4
    fi
    if ! iptables -C FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT 2>/dev/null; then
        iptables -A FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT --reject-with icmp-host-prohibited
    fi
    
    # 配置SNAT
    log_debug "配置 SNAT 规则..."
    iptables -t nat -A POSTROUTING -s "$INTERNAL_NETWORK" -o "$EXTERNAL_IF" -j SNAT --to-source "$EXTERNAL_IP"
    
    # 保存规则
    save_iptables
    
    log_info "✅ SNAT 配置完成"
}

add_allowed_ip() {
    local ip="$1"
    local mode="$2"  # silent模式不显示详细信息
    
    if [ -z "$ip" ]; then
        log_error "请指定IP地址"
        return 1
    fi
    
    # 验证IP格式
    if ! validate_ip "$ip"; then
        log_error "无效的IP地址格式: $ip"
        return 1
    fi
    
    # 检查规则是否已存在
    if iptables -C FORWARD -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT 2>/dev/null; then
        if [ "$mode" != "silent" ]; then
            log_warn "IP $ip 已在允许列表中"
        fi
        return 0
    fi
    
    # 插入到FORWARD链的第二条
    iptables -I FORWARD 2 -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT
    
    if [ $? -eq 0 ]; then
        if [ "$mode" != "silent" ]; then
            log_info "✅ 已添加 $ip 到允许转发列表"
        fi
        return 0
    else
        log_error "添加 $ip 失败"
        return 1
    fi
}

show_snat_summary() {
    print_header "SNAT 配置摘要"
    
    INTERNAL_NETWORK=$(get_internal_network)
    EXTERNAL_IP=$(get_external_ip)
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    echo -e "${CYAN}内网接口:${NC} $INTERNAL_IF"
    echo -e "  • IP: $LOCAL_ENS20_IP"
    echo -e "  • 网段: $INTERNAL_NETWORK"
    echo -e "${CYAN}外网接口:${NC} $EXTERNAL_IF ($EXTERNAL_IP)"
    echo -e "${CYAN}允许转发的IP:${NC}"
    
    for ip in "${ALLOWED_IPS[@]}"; do
        echo "  • $ip"
    done
    
    echo ""
}

###########################################
# 远程策略路由配置函数
###########################################

configure_remote_policy_routing() {
    print_header "远程策略路由配置"
    
    local remote_ip="$1"
    local remote_password="$2"
    local gateway_ip="$3"  # 本机 ens20 IP，作为 IX 端 ens20 的网关
    
    log_info "目标服务器: $remote_ip"
    log_info "ens20 网关将设置为: $gateway_ip (本机 ens20)"
    
    # SSH配置
    local ssh_port=22
    local ssh_user="root"
    
    # 检测SSH连接
    log_step "测试 SSH 连接..."
    
    if ! command -v sshpass &> /dev/null; then
        log_error "需要安装 sshpass 工具"
        echo ""
        echo "请运行: apt install sshpass  或  yum install sshpass"
        return 1
    fi
    
    if ! sshpass -p "$remote_password" ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -p $ssh_port ${ssh_user}@${remote_ip} "echo 'SSH 连接成功'" 2>/dev/null; then
        log_error "SSH 连接失败，请检查 IP 和密码！"
        return 1
    fi
    
    log_info "✅ SSH 连接测试通过"
    
    # 生成远程执行脚本
    log_step "生成策略路由配置脚本..."
    
    local remote_script=$(cat << REMOTE_SCRIPT_EOF
#!/bin/bash
# 远程执行的策略路由配置脚本
# ens20 网关将设置为: $gateway_ip

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_header() {
    echo -e "\${BLUE}==========================================\${NC}"
    echo -e "\${BLUE}  \$1\${NC}"
    echo -e "\${BLUE}==========================================\${NC}"
}

print_success() {
    echo -e "\${GREEN}   ✅ \$1\${NC}"
}

print_info() {
    echo -e "\${YELLOW}   ℹ️  \$1\${NC}"
}

print_error() {
    echo -e "\${RED}   ❌ \$1\${NC}"
    exit 1
}

get_ip() {
    local interface=\$1
    ip addr show \$interface 2>/dev/null | grep 'inet ' | awk '{print \$2}' | cut -d/ -f1 | head -n1
}

get_network() {
    local interface=\$1
    ip addr show \$interface 2>/dev/null | grep 'inet ' | awk '{print \$2}' | head -n1
}

get_gateway() {
    local interface=\$1
    ip route | grep "dev \$interface" | grep via | awk '{print \$3}' | head -n1
}

check_interface() {
    local interface=\$1
    if ! ip link show \$interface &>/dev/null; then
        print_error "网卡 \$interface 不存在！"
    fi
}

configure_policy_routing() {
    print_header "开始配置策略路由"
    
    if [ "\$EUID" -ne 0 ]; then 
        print_error "需要 root 权限"
    fi
    
    echo ""
    echo "【步骤1】检查网卡..."
    check_interface "ens18"
    print_success "ens18 存在"
    check_interface "ens20"
    print_success "ens20 存在"
    
    HAS_ENS19=false
    if ip link show ens19 &>/dev/null; then
        HAS_ENS19=true
        print_success "ens19 存在"
    else
        print_info "ens19 不存在（跳过）"
    fi
    
    echo ""
    echo "【步骤2】读取 ens18 (IX) 配置..."
    IX_IP=\$(get_ip "ens18")
    [ -z "\$IX_IP" ] && print_error "无法读取 ens18 的 IP 地址！"
    print_success "IX IP: \$IX_IP"
    
    IX_GATEWAY=\$(get_gateway "ens18")
    if [ -z "\$IX_GATEWAY" ]; then
        IX_NETWORK=\$(ip addr show ens18 | grep 'inet ' | awk '{print \$2}' | head -n1)
        IX_GATEWAY=\$(echo \$IX_NETWORK | awk -F'.' '{print \$1"."\$2"."\$3".1"}')
        print_info "自动推算网关: \$IX_GATEWAY"
    else
        print_success "检测到网关: \$IX_GATEWAY"
    fi
    
    ENS18_NETWORK=\$(get_network "ens18")
    print_success "IX 网段: \$ENS18_NETWORK"
    
    echo ""
    echo "【步骤3】读取 ens20 配置..."
    ENS20_IP=\$(get_ip "ens20")
    ENS20_NETWORK=\$(get_network "ens20")
    print_success "ens20 IP: \$ENS20_IP"
    print_success "ens20 网段: \$ENS20_NETWORK"
    
    # 使用传入的网关 IP（本机 ens20 IP）
    ENS20_GATEWAY="$gateway_ip"
    print_success "ens20 Gateway: \$ENS20_GATEWAY (SNAT 服务器)"
    
    if [ "\$HAS_ENS19" = true ]; then
        echo ""
        echo "【步骤4】读取 ens19 配置..."
        ENS19_IP=\$(get_ip "ens19")
        ENS19_NETWORK=\$(get_network "ens19")
        print_success "ens19 IP: \$ENS19_IP"
        print_success "ens19 网段: \$ENS19_NETWORK"
    fi
    
    IX_TABLE="ix_return"
    IX_TABLE_ID="100"
    IX_MARK="100"
    
    echo ""
    echo "【步骤5】创建路由表..."
    if ! grep -q "\$IX_TABLE" /etc/iproute2/rt_tables; then
        echo "\$IX_TABLE_ID \$IX_TABLE" >> /etc/iproute2/rt_tables
        print_success "路由表 \$IX_TABLE 已创建"
    else
        print_info "路由表 \$IX_TABLE 已存在"
    fi
    
    echo ""
    echo "【步骤6】清理现有路由配置..."
    ip route del default via \$IX_GATEWAY dev ens18 2>/dev/null
    while ip rule del from \$IX_IP table \$IX_TABLE 2>/dev/null; do :; done
    while ip rule del fwmark \$IX_MARK table \$IX_TABLE 2>/dev/null; do :; done
    ip route flush table \$IX_TABLE
    print_success "旧配置已清理"
    
    echo ""
    echo "【步骤7】配置新路由..."
    ip route del default 2>/dev/null
    ip route add default via \$ENS20_GATEWAY dev ens20
    print_success "默认路由: ens20 -> \$ENS20_GATEWAY"
    
    ip route add default via \$IX_GATEWAY dev ens18 table \$IX_TABLE
    print_success "IX 回程默认路由: ens18 -> \$IX_GATEWAY"
    
    ip route add \$ENS18_NETWORK dev ens18 src \$IX_IP table \$IX_TABLE
    print_success "添加路由: \$ENS18_NETWORK via ens18"
    
    ip route add \$ENS20_NETWORK dev ens20 src \$ENS20_IP table \$IX_TABLE
    print_success "添加路由: \$ENS20_NETWORK via ens20"
    
    if [ "\$HAS_ENS19" = true ] && [ -n "\$ENS19_IP" ]; then
        ip route add \$ENS19_NETWORK dev ens19 src \$ENS19_IP table \$IX_TABLE
        print_success "添加路由: \$ENS19_NETWORK via ens19"
    fi
    
    echo ""
    echo "【步骤8】添加策略路由规则..."
    ip rule add from \$IX_IP table \$IX_TABLE priority 100
    print_success "规则: from \$IX_IP use table \$IX_TABLE (priority 100)"
    
    ip rule add fwmark \$IX_MARK table \$IX_TABLE priority 99
    print_success "规则: fwmark \$IX_MARK use table \$IX_TABLE (priority 99)"
    
    echo ""
    echo "【步骤9】配置 iptables 连接跟踪..."
    iptables -t mangle -D PREROUTING -i ens18 -j CONNMARK --set-mark \$IX_MARK 2>/dev/null
    iptables -t mangle -D OUTPUT -j CONNMARK --restore-mark 2>/dev/null
    iptables -t mangle -A PREROUTING -i ens18 -j CONNMARK --set-mark \$IX_MARK
    iptables -t mangle -A OUTPUT -j CONNMARK --restore-mark
    print_success "连接跟踪已配置"
    
    echo ""
    echo "【步骤10】调整系统参数..."
    sysctl -w net.ipv4.conf.ens18.rp_filter=2 > /dev/null
    sysctl -w net.ipv4.conf.ens20.rp_filter=2 > /dev/null
    sysctl -w net.ipv4.conf.all.rp_filter=2 > /dev/null
    print_success "rp_filter 已设置为宽松模式(2)"
    
    ip route flush cache 2>/dev/null
    print_success "路由缓存已刷新"
    
    echo ""
    echo "【步骤11】保存配置..."
    mkdir -p /etc/iptables
    iptables-save > /etc/iptables/rules.v4
    print_success "iptables 规则已保存"
    
    echo ""
    print_header "策略路由配置完成！"
    echo ""
    echo " 网卡配置："
    echo "   • ens18 (IX): \$IX_IP / \$ENS18_NETWORK -> \$IX_GATEWAY"
    echo "   • ens20: \$ENS20_IP / \$ENS20_NETWORK -> \$ENS20_GATEWAY (SNAT服务器)"
    [ "\$HAS_ENS19" = true ] && echo "   • ens19: \$ENS19_IP / \$ENS19_NETWORK"
    echo ""
    echo " 路由策略："
    echo "   • 默认出站: ens20 -> \$ENS20_GATEWAY (通过SNAT服务器)"
    echo "   • IX 回程: ens18 -> \$IX_GATEWAY"
    echo ""
    echo " 重要提示："
    echo "   • ens20 的网关指向 SNAT 服务器 (\$ENS20_GATEWAY)"
    echo "   • 所有主动发起的连接会通过 SNAT 服务器转发"
    echo "   • IX 流量会从 ens18 原路返回"
    echo ""
}

configure_policy_routing
REMOTE_SCRIPT_EOF
)
    
    # 执行远程配置
    log_step "执行远程策略路由配置..."
    echo ""
    
    if sshpass -p "$remote_password" ssh -o StrictHostKeyChecking=no -p $ssh_port ${ssh_user}@${remote_ip} "bash -s" <<< "$remote_script" 2>&1; then
        echo ""
        log_info "✅ 远程策略路由配置成功！"
        return 0
    else
        echo ""
        log_error "远程配置失败！"
        return 1
    fi
}

###########################################
# 交互式配置主流程
###########################################

interactive_setup() {
    check_root
    
    print_header "SNAT + 策略路由 一体化配置向导"
    
    # 首先获取本机 ens20 IP
    check_interface "$INTERNAL_IF"
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    log_info "本机 ens20 IP: $LOCAL_ENS20_IP"
    log_info "此 IP 将作为 IX 端 ens20 的网关"
    
    # 步骤1: 获取 IX IP 信息
    echo ""
    log_step "步骤 1/3: 配置远程 IX 服务器"
    echo ""
    
    read -p "请输入 IX 服务器的 IP 地址: " IX_SERVER_IP
    if [ -z "$IX_SERVER_IP" ]; then
        log_error "IP 地址不能为空！"
        exit 1
    fi
    
    if ! validate_ip "$IX_SERVER_IP"; then
        log_error "无效的 IP 地址格式！"
        exit 1
    fi
    
    read -s -p "请输入 IX 服务器的 SSH 密码: " IX_SERVER_PASSWORD
    echo ""
    
    if [ -z "$IX_SERVER_PASSWORD" ]; then
        log_error "密码不能为空！"
        exit 1
    fi
    
    # 自动将 IX IP 添加到允许列表
    ALLOWED_IPS+=("$IX_SERVER_IP")
    log_info "✅ IX IP $IX_SERVER_IP 已自动添加到允许列表"
    
    # 步骤2: 添加其他允许的IP
    echo ""
    log_step "步骤 2/3: 配置允许转发的 IP 地址"
    echo ""
    log_info "IX IP ($IX_SERVER_IP) 已自动添加"
    echo ""
    
    
    # 步骤3: 确认配置
    echo ""
    log_step "步骤 3/3: 确认配置"
    echo ""
    echo -e "${CYAN}配置摘要:${NC}"
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "  ${YELLOW}本机 (SNAT 服务器):${NC}"
    echo "    ens20 IP: $LOCAL_ENS20_IP"
    echo "    ens18 (公网出口): $(get_external_ip 2>/dev/null || echo '待检测')"
    echo ""
    echo -e "  ${YELLOW}远程 IX 服务器:${NC}"
    echo "    IP: $IX_SERVER_IP"
    echo "    ens20 网关将设置为: ${GREEN}$LOCAL_ENS20_IP${NC} (本机)"
    echo "    将配置策略路由"
    echo ""
    echo -e "  ${YELLOW}允许转发的 IP 列表:${NC}"
    for ip in "${ALLOWED_IPS[@]}"; do
        if [ "$ip" == "$IX_SERVER_IP" ]; then
            echo "    • $ip ${GREEN}(IX Server)${NC}"
        else
            echo "    • $ip"
        fi
    done
    echo ""
    echo -e "  ${YELLOW}网络拓扑:${NC}"
    echo "    IX Server (ens20) -> $LOCAL_ENS20_IP (本机 ens20) -> 公网 (ens18)"
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    
    read -p "确认开始配置？(yes/no) [yes]: " confirm
    confirm=${confirm:-yes}
    
    if [ "$confirm" != "yes" ]; then
        log_warn "配置已取消"
        exit 0
    fi
    
    # 执行配置
    echo ""
    print_header "开始执行配置"
    
    # 1. 配置本地 SNAT
    echo ""
    log_step "【阶段 1/2】配置本地 SNAT..."
    echo ""
    init_snat
    save_iptables
    
    # 显示 SNAT 配置结果
    show_snat_summary
    
    # 2. 配置远程策略路由（传入本机 ens20 IP 作为网关）
    echo ""
    log_step "【阶段 2/2】配置远程策略路由..."
    echo ""
    
    if configure_remote_policy_routing "$IX_SERVER_IP" "$IX_SERVER_PASSWORD" "$LOCAL_ENS20_IP"; then
        print_header " 全部配置完成！"
        echo ""
        echo -e "${GREEN} 本地 SNAT 配置成功${NC}"
        echo -e "${GREEN} 远程策略路由配置成功${NC}"
        echo ""
        echo -e "${CYAN}配置详情:${NC}"
        echo "  • 本机 ens20 IP: $LOCAL_ENS20_IP"
        echo "  • 允许转发的 IP 数量: ${#ALLOWED_IPS[@]}"
        echo "  • 远程 IX 服务器: $IX_SERVER_IP"
        echo "  • IX ens20 网关: $LOCAL_ENS20_IP (指向本机)"
        echo ""
        echo -e "${CYAN}流量路径:${NC}"
        echo "  ${YELLOW}主动出站:${NC} IX Server -> 本机 ens20 ($LOCAL_ENS20_IP) -> SNAT -> 公网 (ens18)"
        echo "  ${YELLOW}IX 回程:${NC} 公网 -> IX Server ens18 -> 原路返回"
        echo ""
        echo -e "${YELLOW}注意事项:${NC}"
        echo "  • 所有配置已自动保存并持久化"
        echo "  • IX 端 ens20 网关指向本机: $LOCAL_ENS20_IP"
        echo "  • 如需添加更多 IP，请使用: $0 add <IP>"
        echo ""
    else
        echo ""
        log_warn "本地 SNAT 配置成功，但远程策略路由配置失败"
        log_info "您可以稍后手动配置远程服务器"
        log_info "IX 端 ens20 网关应设置为: $LOCAL_ENS20_IP"
    fi
}

###########################################
# 单独命令处理函数
###########################################

handle_add_ip() {
    check_root
    local ip="$1"
    
    if [ -z "$ip" ]; then
        log_error "请指定 IP 地址"
        echo "用法: $0 add <IP地址>"
        exit 1
    fi
    
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    add_allowed_ip "$ip"
    save_iptables
}

handle_del_ip() {
    check_root
    local ip="$1"
    
    if [ -z "$ip" ]; then
        log_error "请指定 IP 地址"
        echo "用法: $0 del <IP地址>"
        exit 1
    fi
    
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    # 删除规则
    if iptables -C FORWARD -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT 2>/dev/null; then
        iptables -D FORWARD -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT
        log_info "✅ 已从允许列表删除 $ip"
        save_iptables
    else
        log_warn "IP $ip 不在允许列表中"
    fi
}

handle_list() {
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    print_header "允许转发的 IP 列表"
    
    INTERNAL_NETWORK=$(get_internal_network)
    EXTERNAL_IP=$(get_external_ip)
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    echo -e "${BLUE}本机配置:${NC}"
    echo -e "  • 内网接口: $INTERNAL_IF ($LOCAL_ENS20_IP)"
    echo -e "  • 外网接口: $EXTERNAL_IF ($EXTERNAL_IP)"
    echo -e "  • 网段: $INTERNAL_NETWORK"
    echo ""
    
    local rules=$(iptables -L FORWARD -n -v --line-numbers | grep "$EXTERNAL_IF" | grep ACCEPT | grep -v "state RELATED,ESTABLISHED")
    
    if [ -z "$rules" ]; then
        log_warn "当前没有配置允许转发的 IP"
    else
        echo -e "${GREEN}序号  数据包  字节数    源地址${NC}"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "$rules" | awk '{printf "%-6s%-8s%-10s%s\n", $1, $2, $3, $8}'
    fi
    
    echo ""
}

show_help() {
    cat << EOF
${GREEN}SNAT + 策略路由 一体化配置脚本${NC}

${YELLOW}用法:${NC}
    $0                    # 运行交互式配置向导
    $0 <command> [args]   # 执行单独命令

${YELLOW}可用命令:${NC}
    ${BLUE}setup${NC}               运行完整配置向导（推荐首次使用）
    ${BLUE}add${NC} <IP>           添加允许转发的 IP 地址
    ${BLUE}del${NC} <IP>           删除允许转发的 IP 地址
    ${BLUE}list${NC}                列出所有允许转发的 IP
    ${BLUE}help${NC}                显示此帮助信息

${YELLOW}配置向导包含:${NC}
    1. 输入 IX 服务器 IP 和密码
    2. 自动将 IX IP 添加到 SNAT 允许列表
    3. 可选添加其他允许转发的 IP
    4. 自动配置本地 SNAT
    5. 自动配置远程策略路由
    ${GREEN}6. IX 端 ens20 网关自动设置为本机 ens20 IP${NC}

${YELLOW}网络拓扑:${NC}
    IX Server (ens20) -> 本机 ens20 IP -> SNAT -> 公网 (ens18)
    
    本机 ens20 IP 作为 IX 端的默认网关

${YELLOW}示例:${NC}
    # 首次使用 - 运行完整配置向导
    $0
    或
    $0 setup
    
    # 之后添加更多允许的 IP
    $0 add 192.168.1.105
    $0 add 192.168.1.0/24
    
    # 删除 IP
    $0 del 192.168.1.105
    
    # 查看允许列表
    $0 list

${YELLOW}网络接口:${NC}
    内网接口: $INTERNAL_IF
    外网接口: $EXTERNAL_IF

${YELLOW}前置要求:${NC}
    • 必须使用 root 权限运行
    • 需要安装 sshpass: apt install sshpass

${YELLOW}功能说明:${NC}
    • IX IP 会自动添加到 SNAT 允许列表
    • IX 端 ens20 网关自动指向本机 ens20 IP
    • 支持单个 IP 和 CIDR 格式的网段
    • 所有配置自动保存并持久化
    • 远程配置通过 SSH 自动完成
EOF
}

###########################################
# 主函数
###########################################

main() {
	apt install sshpass -y >> /dev/null
	
    case "${1:-setup}" in
        setup|init|config|configure)
            interactive_setup
            ;;
        add)
            handle_add_ip "$2"
            ;;
        del|delete|remove)
            handle_del_ip "$2"
            ;;
        list|ls|show)
            handle_list
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            if [ -z "$1" ]; then
                interactive_setup
            else
                log_error "未知命令: $1"
                echo ""
                show_help
                exit 1
            fi
            ;;
    esac
}

# 执行主函数
main "$@"
