#!/bin/bash
###########################################
# SNAT + ç­–ç•¥è·¯ç”± ä¸€ä½“åŒ–é…ç½®è„šæœ¬
# ç®€åŒ–ç‰ˆï¼šä»…æ£€æŸ¥ç½‘ç»œå’Œç«¯å£ï¼Œä¸æµ‹è¯•SSHè¿æ¥
###########################################

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# å…¨å±€å˜é‡
INTERNAL_IF="ens20"
EXTERNAL_IF="ens18"
ALLOWED_IPS=()
LOCAL_ENS20_IP=""

###########################################
# å·¥å…·å‡½æ•°
###########################################

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_debug() {
    echo -e "${BLUE}[DEBUG]${NC} $1"
}

log_step() {
    echo -e "${PURPLE}[STEP]${NC} $1"
}

print_header() {
    echo ""
    echo -e "${CYAN}=============================================================${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}=============================================================${NC}"
    echo ""
}

check_root() {
    if [ "$EUID" -ne 0 ]; then 
        log_error "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
}

check_interface() {
    if ! ip link show "$1" &> /dev/null; then
        log_error "ç½‘å¡ $1 ä¸å­˜åœ¨"
        exit 1
    fi
    log_debug "ç½‘å¡ $1 æ£€æŸ¥é€šè¿‡"
}

get_internal_network() {
    local network=$(ip -o -f inet addr show "$INTERNAL_IF" | awk '{print $4}')
    if [ -z "$network" ]; then
        log_error "æ— æ³•ä» $INTERNAL_IF è·å–IPæ®µ"
        exit 1
    fi
    echo "$network"
}

get_internal_ip() {
    local ip=$(ip -o -f inet addr show "$INTERNAL_IF" | awk '{print $4}' | cut -d'/' -f1)
    if [ -z "$ip" ]; then
        log_error "æ— æ³•ä» $INTERNAL_IF è·å–IPåœ°å€"
        exit 1
    fi
    echo "$ip"
}

get_external_ip() {
    local ip=$(ip -o -f inet addr show "$EXTERNAL_IF" | awk '{print $4}' | cut -d'/' -f1)
    if [ -z "$ip" ]; then
        log_error "æ— æ³•ä» $EXTERNAL_IF è·å–å…¬ç½‘IP"
        exit 1
    fi
    echo "$ip"
}

validate_ip() {
    local ip=$1
    if [[ "$ip" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}(/[0-9]{1,2})?$ ]]; then
        return 0
    else
        return 1
    fi
}

save_iptables() {
    log_debug "ä¿å­˜ iptables è§„åˆ™..."
    if command -v iptables-save &> /dev/null; then
        mkdir -p /etc/iptables
        iptables-save > /etc/iptables/rules.v4
        log_debug "è§„åˆ™å·²ä¿å­˜"
    else
        log_warn "æœªæ‰¾åˆ° iptables-save å‘½ä»¤ï¼Œè§„åˆ™æœªæŒä¹…åŒ–"
    fi
}

###########################################
# ç®€åŒ–çš„ç½‘ç»œæ£€æŸ¥å‡½æ•°
###########################################

check_network_connectivity() {
    local remote_ip="$1"
    local ssh_port="${2:-22}"
    
    print_header "ç½‘ç»œè¿é€šæ€§æ£€æŸ¥"
    
    # 1. æ£€æŸ¥ sshpass å·¥å…·
    echo -e "${BLUE}[æ£€æŸ¥ 1/3]${NC} æ£€æŸ¥å¿…è¦å·¥å…·..."
    if ! command -v sshpass &> /dev/null; then
        log_error "æœªå®‰è£… sshpass å·¥å…·"
        echo ""
        echo -e "${YELLOW}è¯·å…ˆå®‰è£… sshpassï¼š${NC}"
        echo "  Debian/Ubuntu: apt install sshpass"
        echo "  CentOS/RHEL:   yum install sshpass"
        echo ""
        return 1
    fi
    log_info "âœ“ sshpass å·²å®‰è£…"
    
    # 2. æ£€æŸ¥ IP åœ°å€å¯è¾¾æ€§
    echo ""
    echo -e "${BLUE}[æ£€æŸ¥ 2/3]${NC} æµ‹è¯• IP å¯è¾¾æ€§..."
    if ping -c 2 -W 3 "$remote_ip" &>/dev/null; then
        log_info "âœ“ IP åœ°å€ $remote_ip å¯è¾¾ (ICMP)"
    else
        log_warn "âš  IP åœ°å€ $remote_ip ICMP ä¸é€š"
        echo ""
        echo -e "${YELLOW}å¯èƒ½çš„åŸå› ï¼š${NC}"
        echo "  1. ç›®æ ‡ä¸»æœºé˜²ç«å¢™é˜»æ­¢ ICMP"
        echo "  2. ç½‘ç»œè·¯ç”±é—®é¢˜"
        echo "  3. IP åœ°å€é”™è¯¯"
        echo ""
        echo -e "${CYAN}æç¤ºï¼š${NC}å³ä½¿ ping ä¸é€šï¼ŒSSH å¯èƒ½ä»ç„¶å¯ç”¨ï¼Œå°†ç»§ç»­æ£€æŸ¥..."
        echo ""
    fi
    
    # 3. æ£€æŸ¥ SSH ç«¯å£æ˜¯å¦å¼€æ”¾
    echo ""
    echo -e "${BLUE}[æ£€æŸ¥ 3/3]${NC} æµ‹è¯• SSH ç«¯å£ ($ssh_port) å¯è¾¾æ€§..."
    local port_status="unknown"
    
    # å°è¯•å¤šç§ç«¯å£æ£€æµ‹æ–¹æ³•
    if command -v nc &> /dev/null; then
        if timeout 5 nc -zv "$remote_ip" "$ssh_port" 2>&1 | grep -q "succeeded\|open"; then
            port_status="open"
        else
            port_status="closed"
        fi
    elif command -v telnet &> /dev/null; then
        if timeout 5 bash -c "echo '' | telnet $remote_ip $ssh_port 2>&1" | grep -q "Connected\|Escape"; then
            port_status="open"
        else
            port_status="closed"
        fi
    else
        # ä½¿ç”¨ bash å†…ç½®çš„ /dev/tcp
        if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$remote_ip/$ssh_port" 2>/dev/null; then
            port_status="open"
        else
            port_status="closed"
        fi
    fi
    
    if [ "$port_status" = "open" ]; then
        log_info "âœ“ SSH ç«¯å£ $ssh_port å·²å¼€æ”¾"
        echo ""
        log_info "ç½‘ç»œè¿é€šæ€§æ£€æŸ¥é€šè¿‡ï¼Œå‡†å¤‡è¿›è¡Œé…ç½®..."
        echo ""
        return 0
        
    elif [ "$port_status" = "closed" ]; then
        log_error "âœ— SSH ç«¯å£ $ssh_port æ— æ³•è®¿é—®"
        echo ""
        echo -e "${YELLOW}å¯èƒ½çš„åŸå› ï¼š${NC}"
        echo "  1. SSH æœåŠ¡æœªå¯åŠ¨"
        echo "  2. é˜²ç«å¢™é˜»æ­¢äº†ç«¯å£ $ssh_port"
        echo "  3. SSH ç›‘å¬åœ¨ä¸åŒçš„ç«¯å£"
        echo "  4. ç½‘ç»œè·¯ç”±é—®é¢˜"
        echo ""
        echo -e "${YELLOW}å»ºè®®æ£€æŸ¥ï¼ˆåœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šï¼‰ï¼š${NC}"
        echo "  â€¢ æ£€æŸ¥ SSH æœåŠ¡çŠ¶æ€:"
        echo "    systemctl status sshd"
        echo ""
        echo "  â€¢ æ£€æŸ¥ç«¯å£ç›‘å¬:"
        echo "    ss -tlnp | grep :$ssh_port"
        echo "    netstat -tlnp | grep :$ssh_port"
        echo ""
        echo "  â€¢ æ£€æŸ¥é˜²ç«å¢™:"
        echo "    iptables -L -n | grep $ssh_port"
        echo "    firewall-cmd --list-all"
        echo ""
        
        read -p "ç«¯å£æ£€æµ‹å¤±è´¥ï¼Œæ˜¯å¦ä»è¦ç»§ç»­å°è¯•é…ç½®ï¼Ÿ(y/n) [n]: " continue_anyway
        if [[ "$continue_anyway" =~ ^[Yy]$ ]]; then
            log_warn "ç”¨æˆ·é€‰æ‹©ç»§ç»­é…ç½®..."
            return 0
        else
            return 1
        fi
        
    else
        log_warn "âš  æ— æ³•ç¡®å®šç«¯å£çŠ¶æ€"
        echo ""
        echo -e "${CYAN}æç¤ºï¼š${NC}ç«¯å£æ£€æµ‹å·¥å…·ä¸å¯ç”¨æˆ–æ£€æµ‹å¤±è´¥ï¼Œä½†è¿™ä¸ä¸€å®šæ„å‘³ç€ SSH ä¸å¯ç”¨"
        echo ""
        read -p "æ˜¯å¦ç»§ç»­å°è¯•é…ç½®ï¼Ÿ(y/n) [y]: " continue_anyway
        continue_anyway=${continue_anyway:-y}
        if [[ "$continue_anyway" =~ ^[Yy]$ ]]; then
            return 0
        else
            return 1
        fi
    fi
}

# è¾“å…¥å¯†ç å‡½æ•°
get_ssh_password() {
    local remote_ip="$1"
    local max_retries=3
    local retry_count=0
    
    while [ $retry_count -lt $max_retries ]; do
        if [ $retry_count -gt 0 ]; then
            echo ""
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${YELLOW}ç¬¬ $((retry_count + 1)) æ¬¡è¾“å…¥ (å…± $max_retries æ¬¡æœºä¼š)${NC}"
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        fi
        
        read -s -p "è¯·è¾“å…¥ SSH å¯†ç : " remote_password
        echo ""
        
        if [ -z "$remote_password" ]; then
            log_error "å¯†ç ä¸èƒ½ä¸ºç©ºï¼"
            retry_count=$((retry_count + 1))
            continue
        fi
        
        # ç¡®è®¤å¯†ç 
        read -s -p "è¯·å†æ¬¡è¾“å…¥å¯†ç ç¡®è®¤: " remote_password_confirm
        echo ""
        
        if [ "$remote_password" != "$remote_password_confirm" ]; then
            log_error "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼"
            retry_count=$((retry_count + 1))
            continue
        fi
        
        echo "$remote_password"
        return 0
    done
    
    echo ""
    log_error "å¯†ç è¾“å…¥å¤±è´¥æ¬¡æ•°è¿‡å¤š"
    return 1
}

###########################################
# SNAT é…ç½®å‡½æ•°
###########################################

init_snat() {
    log_step "åˆå§‹åŒ– SNAT é…ç½®..."
    
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    INTERNAL_NETWORK=$(get_internal_network)
    EXTERNAL_IP=$(get_external_ip)
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    log_info "å†…ç½‘ç½‘æ®µ: $INTERNAL_NETWORK"
    log_info "å†…ç½‘IP (ens20): $LOCAL_ENS20_IP"
    log_info "å¤–ç½‘IP (ens18): $EXTERNAL_IP"
    
    log_debug "å¯ç”¨IPè½¬å‘..."
    echo 1 > /proc/sys/net/ipv4/ip_forward
    
    if ! grep -q "^net.ipv4.ip_forward=1" /etc/sysctl.conf; then
        echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
        sysctl -p > /dev/null 2>&1
    fi
    
    iptables -t nat -D POSTROUTING -s "$INTERNAL_NETWORK" -o "$EXTERNAL_IF" -j SNAT --to-source "$EXTERNAL_IP" 2>/dev/null
    
    log_debug "è®¾ç½®é»˜è®¤ç­–ç•¥..."
    iptables -P FORWARD DROP
    
    iptables -D FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG 2>/dev/null
    iptables -D FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT 2>/dev/null
    
    if ! iptables -C FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 2>/dev/null; then
        log_debug "å…è®¸å·²å»ºç«‹å’Œç›¸å…³çš„è¿æ¥..."
        iptables -I FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT
    fi
    
    log_debug "é…ç½®å…è®¸è½¬å‘çš„IP..."
    for ip in "${ALLOWED_IPS[@]}"; do
        add_allowed_ip "$ip" "silent"
    done
    
    log_debug "é…ç½®æ‹’ç»å…¶ä»–IPçš„è½¬å‘..."
    if ! iptables -C FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG --log-prefix "FORWARD_REJECT: " 2>/dev/null; then
        iptables -A FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG --log-prefix "FORWARD_REJECT: " --log-level 4
    fi
    if ! iptables -C FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT 2>/dev/null; then
        iptables -A FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT --reject-with icmp-host-prohibited
    fi
    
    log_debug "é…ç½® SNAT è§„åˆ™..."
    iptables -t nat -A POSTROUTING -s "$INTERNAL_NETWORK" -o "$EXTERNAL_IF" -j SNAT --to-source "$EXTERNAL_IP"
    
    save_iptables
    
    log_info "âœ… SNAT é…ç½®å®Œæˆ"
}

add_allowed_ip() {
    local ip="$1"
    local mode="$2"
    
    if [ -z "$ip" ]; then
        log_error "è¯·æŒ‡å®šIPåœ°å€"
        return 1
    fi
    
    if ! validate_ip "$ip"; then
        log_error "æ— æ•ˆçš„IPåœ°å€æ ¼å¼: $ip"
        return 1
    fi
    
    if iptables -C FORWARD -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT 2>/dev/null; then
        if [ "$mode" != "silent" ]; then
            log_warn "IP $ip å·²åœ¨å…è®¸åˆ—è¡¨ä¸­"
        fi
        return 0
    fi
    
    iptables -I FORWARD 2 -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT
    
    if [ $? -eq 0 ]; then
        if [ "$mode" != "silent" ]; then
            log_info "âœ… å·²æ·»åŠ  $ip åˆ°å…è®¸è½¬å‘åˆ—è¡¨"
        fi
        return 0
    else
        log_error "æ·»åŠ  $ip å¤±è´¥"
        return 1
    fi
}

show_snat_summary() {
    print_header "SNAT é…ç½®æ‘˜è¦"
    
    INTERNAL_NETWORK=$(get_internal_network)
    EXTERNAL_IP=$(get_external_ip)
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    echo -e "${CYAN}å†…ç½‘æ¥å£:${NC} $INTERNAL_IF"
    echo -e "  â€¢ IP: $LOCAL_ENS20_IP"
    echo -e "  â€¢ ç½‘æ®µ: $INTERNAL_NETWORK"
    echo -e "${CYAN}å¤–ç½‘æ¥å£:${NC} $EXTERNAL_IF ($EXTERNAL_IP)"
    echo -e "${CYAN}å…è®¸è½¬å‘çš„IP:${NC}"
    
    for ip in "${ALLOWED_IPS[@]}"; do
        echo "  â€¢ $ip"
    done
    
    echo ""
}

###########################################
# è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®å‡½æ•°
###########################################

configure_remote_policy_routing() {
    print_header "è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®"
    
    local remote_ip="$1"
    local remote_password="$2"
    local gateway_ip="$3"
    
    log_info "ç›®æ ‡æœåŠ¡å™¨: $remote_ip"
    log_info "ens20 ç½‘å…³å°†è®¾ç½®ä¸º: $gateway_ip (æœ¬æœº ens20)"
    
    local ssh_port=22
    local ssh_user="root"
    
    log_step "ç”Ÿæˆç­–ç•¥è·¯ç”±é…ç½®è„šæœ¬..."
    
    local temp_script="/tmp/remote_policy_routing_$$.sh"
    
    cat > "$temp_script" << 'EOF'
#!/bin/bash
# è¿œç¨‹æ‰§è¡Œçš„ç­–ç•¥è·¯ç”±é…ç½®è„šæœ¬

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

print_header() {
    echo -e "${BLUE}==============================================================${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}==============================================================${NC}"
}

print_success() {
    echo -e "${GREEN}   âœ… $1${NC}"
}

print_info() {
    echo -e "${YELLOW}   â„¹ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}   âŒ $1${NC}"
    exit 1
}

get_ip() {
    local interface=$1
    ip addr show $interface 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 | head -n1
}

get_network() {
    local interface=$1
    ip addr show $interface 2>/dev/null | grep 'inet ' | awk '{print $2}' | head -n1
}

get_gateway() {
    local interface=$1
    ip route | grep "dev $interface" | grep via | awk '{print $3}' | head -n1
}

check_interface() {
    local interface=$1
    if ! ip link show $interface &>/dev/null; then
        print_error "ç½‘å¡ $interface ä¸å­˜åœ¨ï¼"
    fi
}

detect_system() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VER=$VERSION_ID
    elif [ -f /etc/redhat-release ]; then
        OS="rhel"
    else
        OS="unknown"
    fi
    
    if systemctl is-active --quiet NetworkManager 2>/dev/null; then
        NETWORK_MANAGER="NetworkManager"
    elif systemctl is-active --quiet systemd-networkd 2>/dev/null; then
        NETWORK_MANAGER="systemd-networkd"
    elif [ -f /etc/network/interfaces ]; then
        NETWORK_MANAGER="interfaces"
    elif [ -d /etc/sysconfig/network-scripts ]; then
        NETWORK_MANAGER="network-scripts"
    else
        NETWORK_MANAGER="unknown"
    fi
    
    print_info "ç³»ç»Ÿ: $OS, ç½‘ç»œç®¡ç†: $NETWORK_MANAGER"
}

configure_dns() {
    print_info "é…ç½® DNS æœåŠ¡å™¨..."
    
    DNS1="1.1.1.1"
    DNS2="8.8.8.8"
    
    if [ -f /etc/resolv.conf ] && [ ! -f /etc/resolv.conf.backup ]; then
        cp /etc/resolv.conf /etc/resolv.conf.backup
        print_info "å·²å¤‡ä»½åŸ DNS é…ç½®"
    fi
    
    chattr -i /etc/resolv.conf 2>/dev/null
    
    cat > /etc/resolv.conf << DNSEOF
# DNS Configuration
nameserver $DNS1
nameserver $DNS2
options timeout:2 attempts:3
DNSEOF
    
    cat > /usr/local/bin/setup-dns.sh << 'DNSSCRIPT'
#!/bin/bash
chattr -i /etc/resolv.conf 2>/dev/null
cat > /etc/resolv.conf << RESOLVEOF
nameserver 1.1.1.1
nameserver 8.8.8.8
options timeout:2 attempts:3
RESOLVEOF
chattr +i /etc/resolv.conf 2>/dev/null
DNSSCRIPT

    chmod +x /usr/local/bin/setup-dns.sh
    /usr/local/bin/setup-dns.sh
    
    print_success "DNS å·²é…ç½®: $DNS1, $DNS2"
}

persist_routes_generic() {
    print_info "æŒä¹…åŒ–è·¯ç”±é…ç½®..."
    
    cat > /usr/local/bin/setup-policy-routing.sh << 'RCSCRIPT'
#!/bin/bash
sleep 3

IX_IP=$(ip addr show ens18 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 | head -n1)
IX_GATEWAY=$(ip route | grep "dev ens18" | grep via | awk '{print $3}' | head -n1)
ENS20_GATEWAY="__GATEWAY_IP__"

IX_TABLE="ix_return"
IX_TABLE_ID="100"
IX_MARK="100"

if ! grep -q "$IX_TABLE" /etc/iproute2/rt_tables; then
    echo "$IX_TABLE_ID $IX_TABLE" >> /etc/iproute2/rt_tables
fi

ip rule del from $IX_IP table $IX_TABLE 2>/dev/null
ip rule add from $IX_IP table $IX_TABLE priority 100

ip rule del fwmark $IX_MARK table $IX_TABLE 2>/dev/null
ip rule add fwmark $IX_MARK table $IX_TABLE priority 99

ip route flush table $IX_TABLE

[ -n "$IX_GATEWAY" ] && ip route add default via $IX_GATEWAY dev ens18 table $IX_TABLE

for iface in ens18 ens20 ens19; do
    if ip link show $iface &>/dev/null; then
        NETWORK=$(ip addr show $iface 2>/dev/null | grep 'inet ' | awk '{print $2}' | head -n1)
        SRC_IP=$(ip addr show $iface 2>/dev/null | grep 'inet ' | awk '{print $2}' | cut -d/ -f1 | head -n1)
        [ -n "$NETWORK" ] && [ -n "$SRC_IP" ] && ip route add $NETWORK dev $iface src $SRC_IP table $IX_TABLE
    fi
done

ip route del default 2>/dev/null
ip route add default via $ENS20_GATEWAY dev ens20
ip route flush cache 2>/dev/null
RCSCRIPT

    sed -i "s/__GATEWAY_IP__/$ENS20_GATEWAY/g" /usr/local/bin/setup-policy-routing.sh
    chmod +x /usr/local/bin/setup-policy-routing.sh
    
    if [ -f /etc/rc.local ]; then
        if ! grep -q "setup-policy-routing.sh" /etc/rc.local; then
            sed -i '/^exit 0/d' /etc/rc.local
            echo "/usr/local/bin/setup-policy-routing.sh &" >> /etc/rc.local
            echo "/usr/local/bin/setup-dns.sh &" >> /etc/rc.local
            echo "exit 0" >> /etc/rc.local
        fi
        chmod +x /etc/rc.local
    else
        cat > /etc/rc.local << 'RCLOCALFILE'
#!/bin/bash
/usr/local/bin/setup-policy-routing.sh &
/usr/local/bin/setup-dns.sh &
exit 0
RCLOCALFILE
        chmod +x /etc/rc.local
    fi
    
    if command -v systemctl &>/dev/null; then
        cat > /etc/systemd/system/rc-local.service << 'RCLOCALSERVICE'
[Unit]
Description=/etc/rc.local Compatibility
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
RCLOCALSERVICE
        
        systemctl daemon-reload
        systemctl enable rc-local.service 2>/dev/null
    fi
    
    print_success "è·¯ç”±æŒä¹…åŒ–é…ç½®å®Œæˆ"
}

persist_iptables() {
    print_info "æŒä¹…åŒ– iptables è§„åˆ™..."
    
    mkdir -p /etc/iptables
    iptables-save > /etc/iptables/rules.v4
    
    if command -v systemctl &>/dev/null; then
        cat > /etc/systemd/system/iptables-restore.service << 'IPTSERVICE'
[Unit]
Description=Restore iptables rules
Before=network-pre.target

[Service]
Type=oneshot
ExecStart=/sbin/iptables-restore /etc/iptables/rules.v4

[Install]
WantedBy=multi-user.target
IPTSERVICE
        
        systemctl daemon-reload
        systemctl enable iptables-restore.service 2>/dev/null
    fi
    
    print_success "iptables è§„åˆ™å·²æŒä¹…åŒ–"
}

persist_sysctl() {
    print_info "æŒä¹…åŒ– sysctl é…ç½®..."
    
    cat > /etc/sysctl.d/99-policy-routing.conf << 'SYSCTLCONF'
net.ipv4.conf.ens18.rp_filter=2
net.ipv4.conf.ens20.rp_filter=2
net.ipv4.conf.all.rp_filter=2
net.ipv4.ip_forward=1
SYSCTLCONF
    
    sysctl -p /etc/sysctl.d/99-policy-routing.conf > /dev/null 2>&1
    print_success "sysctl é…ç½®å·²æŒä¹…åŒ–"
}

configure_policy_routing() {
    print_header "å¼€å§‹é…ç½®ç­–ç•¥è·¯ç”±"
    
    if [ "$EUID" -ne 0 ]; then 
        print_error "éœ€è¦ root æƒé™"
    fi
    
    detect_system
    
    echo ""
    echo "ã€æ­¥éª¤1ã€‘æ£€æŸ¥ç½‘å¡..."
    check_interface "ens18"
    print_success "ens18 å­˜åœ¨"
    check_interface "ens20"
    print_success "ens20 å­˜åœ¨"
    
    HAS_ENS19=false
    if ip link show ens19 &>/dev/null; then
        HAS_ENS19=true
        print_success "ens19 å­˜åœ¨"
    else
        print_info "ens19 ä¸å­˜åœ¨ï¼ˆè·³è¿‡ï¼‰"
    fi
    
    echo ""
    echo "ã€æ­¥éª¤2ã€‘è¯»å– ens18 (IX) é…ç½®..."
    IX_IP=$(get_ip "ens18")
    [ -z "$IX_IP" ] && print_error "æ— æ³•è¯»å– ens18 çš„ IP åœ°å€ï¼"
    print_success "IX IP: $IX_IP"
    
    IX_GATEWAY=$(get_gateway "ens18")
    if [ -z "$IX_GATEWAY" ]; then
        IX_NETWORK=$(ip addr show ens18 2>/dev/null | grep 'inet ' | awk '{print $2}' | head -n1)
        IX_GATEWAY=$(echo $IX_NETWORK | awk -F'.' '{print $1"."$2"."$3".1"}')
        print_info "è‡ªåŠ¨æ¨ç®—ç½‘å…³: $IX_GATEWAY"
    else
        print_success "æ£€æµ‹åˆ°ç½‘å…³: $IX_GATEWAY"
    fi
    
    ENS18_NETWORK=$(get_network "ens18")
    print_success "IX ç½‘æ®µ: $ENS18_NETWORK"
    
    echo ""
    echo "ã€æ­¥éª¤3ã€‘è¯»å– ens20 é…ç½®..."
    ENS20_IP=$(get_ip "ens20")
    ENS20_NETWORK=$(get_network "ens20")
    print_success "ens20 IP: $ENS20_IP"
    print_success "ens20 ç½‘æ®µ: $ENS20_NETWORK"
    
    ENS20_GATEWAY="__GATEWAY_IP__"
    print_success "ens20 Gateway: $ENS20_GATEWAY (SNAT æœåŠ¡å™¨)"
    
    if [ "$HAS_ENS19" = true ]; then
        echo ""
        echo "ã€æ­¥éª¤4ã€‘è¯»å– ens19 é…ç½®..."
        ENS19_IP=$(get_ip "ens19")
        ENS19_NETWORK=$(get_network "ens19")
        print_success "ens19 IP: $ENS19_IP"
        print_success "ens19 ç½‘æ®µ: $ENS19_NETWORK"
    fi
    
    echo ""
    echo "ã€æ­¥éª¤5ã€‘é…ç½® DNS..."
    configure_dns
    
    IX_TABLE="ix_return"
    IX_TABLE_ID="100"
    IX_MARK="100"
    
    echo ""
    echo "ã€æ­¥éª¤6ã€‘åˆ›å»ºè·¯ç”±è¡¨..."
    if ! grep -q "$IX_TABLE" /etc/iproute2/rt_tables; then
        echo "$IX_TABLE_ID $IX_TABLE" >> /etc/iproute2/rt_tables
        print_success "è·¯ç”±è¡¨ $IX_TABLE å·²åˆ›å»º"
    else
        print_info "è·¯ç”±è¡¨ $IX_TABLE å·²å­˜åœ¨"
    fi
    
    echo ""
    echo "ã€æ­¥éª¤7ã€‘æ¸…ç†ç°æœ‰è·¯ç”±é…ç½®..."
    ip route del default via $IX_GATEWAY dev ens18 2>/dev/null
    while ip rule del from $IX_IP table $IX_TABLE 2>/dev/null; do :; done
    while ip rule del fwmark $IX_MARK table $IX_TABLE 2>/dev/null; do :; done
    ip route flush table $IX_TABLE
    print_success "æ—§é…ç½®å·²æ¸…ç†"
    
    echo ""
    echo "ã€æ­¥éª¤8ã€‘é…ç½®æ–°è·¯ç”±..."
    ip route del default 2>/dev/null
    ip route add default via $ENS20_GATEWAY dev ens20
    print_success "é»˜è®¤è·¯ç”±: ens20 -> $ENS20_GATEWAY"
    
    ip route add default via $IX_GATEWAY dev ens18 table $IX_TABLE
    print_success "IX å›ç¨‹é»˜è®¤è·¯ç”±: ens18 -> $IX_GATEWAY"
    
    ip route add $ENS18_NETWORK dev ens18 src $IX_IP table $IX_TABLE
    print_success "æ·»åŠ è·¯ç”±: $ENS18_NETWORK via ens18"
    
    ip route add $ENS20_NETWORK dev ens20 src $ENS20_IP table $IX_TABLE
    print_success "æ·»åŠ è·¯ç”±: $ENS20_NETWORK via ens20"
    
    if [ "$HAS_ENS19" = true ] && [ -n "$ENS19_IP" ]; then
        ip route add $ENS19_NETWORK dev ens19 src $ENS19_IP table $IX_TABLE
        print_success "æ·»åŠ è·¯ç”±: $ENS19_NETWORK via ens19"
    fi
    
    echo ""
    echo "ã€æ­¥éª¤9ã€‘æ·»åŠ ç­–ç•¥è·¯ç”±è§„åˆ™..."
    ip rule add from $IX_IP table $IX_TABLE priority 100
    print_success "è§„åˆ™: from $IX_IP use table $IX_TABLE (priority 100)"
    
    ip rule add fwmark $IX_MARK table $IX_TABLE priority 99
    print_success "è§„åˆ™: fwmark $IX_MARK use table $IX_TABLE (priority 99)"
    
    echo ""
    echo "ã€æ­¥éª¤10ã€‘é…ç½® iptables è¿æ¥è·Ÿè¸ª..."
    iptables -t mangle -D PREROUTING -i ens18 -j CONNMARK --set-mark $IX_MARK 2>/dev/null
    iptables -t mangle -D OUTPUT -j CONNMARK --restore-mark 2>/dev/null
    iptables -t mangle -A PREROUTING -i ens18 -j CONNMARK --set-mark $IX_MARK
    iptables -t mangle -A OUTPUT -j CONNMARK --restore-mark
    print_success "è¿æ¥è·Ÿè¸ªå·²é…ç½®"
    
    echo ""
    echo "ã€æ­¥éª¤11ã€‘è°ƒæ•´ç³»ç»Ÿå‚æ•°..."
    sysctl -w net.ipv4.conf.ens18.rp_filter=2 > /dev/null
    sysctl -w net.ipv4.conf.ens20.rp_filter=2 > /dev/null
    sysctl -w net.ipv4.conf.all.rp_filter=2 > /dev/null
    print_success "rp_filter å·²è®¾ç½®ä¸ºå®½æ¾æ¨¡å¼(2)"
    
    ip route flush cache 2>/dev/null
    print_success "è·¯ç”±ç¼“å­˜å·²åˆ·æ–°"
    
    echo ""
    echo "ã€æ­¥éª¤12ã€‘æŒä¹…åŒ–é…ç½®..."
    persist_sysctl
    persist_iptables
    persist_routes_generic
    print_success "æ‰€æœ‰é…ç½®å·²æŒä¹…åŒ–"
    
    echo ""
    print_header "ç­–ç•¥è·¯ç”±é…ç½®å®Œæˆï¼"
    echo ""
    echo "ğŸ“Œ ç½‘å¡é…ç½®ï¼š"
    echo "   â€¢ ens18 (IX): $IX_IP / $ENS18_NETWORK -> $IX_GATEWAY"
    echo "   â€¢ ens20: $ENS20_IP / $ENS20_NETWORK -> $ENS20_GATEWAY (SNATæœåŠ¡å™¨)"
    [ "$HAS_ENS19" = true ] && echo "   â€¢ ens19: $ENS19_IP / $ENS19_NETWORK"
    echo ""
    echo "ğŸ“Œ DNS é…ç½®ï¼š"
    echo "   â€¢ ä¸» DNS: 1.1.1.1 (Cloudflare)"
    echo "   â€¢ å¤‡ DNS: 8.8.8.8 (Google)"
    echo ""
    echo "ğŸ“Œ è·¯ç”±ç­–ç•¥ï¼š"
    echo "   â€¢ é»˜è®¤å‡ºç«™: ens20 -> $ENS20_GATEWAY (é€šè¿‡SNATæœåŠ¡å™¨)"
    echo "   â€¢ IX å›ç¨‹: ens18 -> $IX_GATEWAY"
    echo ""
}

configure_policy_routing
EOF

    sed -i "s/__GATEWAY_IP__/$gateway_ip/g" "$temp_script"
    
    log_step "æ‰§è¡Œè¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®..."
    echo ""
    
    echo -e "${CYAN}å¼€å§‹è¿œç¨‹é…ç½®ï¼Œè¯·ç¨å€™...${NC}"
    echo ""
    
    if SSHPASS="$remote_password" sshpass -e ssh \
        -o ConnectTimeout=15 \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        -p $ssh_port ${ssh_user}@${remote_ip} "bash -s" < "$temp_script" 2>&1; then
        echo ""
        log_info "âœ… è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®æˆåŠŸï¼"
        rm -f "$temp_script"
        return 0
    else
        local ssh_error=$?
        echo ""
        log_error "è¿œç¨‹é…ç½®å¤±è´¥ï¼(é€€å‡ºç : $ssh_error)"
        echo ""
        echo -e "${YELLOW}å¯èƒ½çš„åŸå› ï¼š${NC}"
        echo "  1. SSH å¯†ç é”™è¯¯"
        echo "  2. SSH æœåŠ¡é…ç½®ä¸å…è®¸å¯†ç ç™»å½•"
        echo "  3. ç”¨æˆ·æƒé™ä¸è¶³"
        echo "  4. ç½‘ç»œè¿æ¥ä¸­æ–­"
        echo ""
        echo -e "${YELLOW}å»ºè®®æ“ä½œï¼š${NC}"
        echo "  â€¢ ç¡®è®¤å¯†ç æ­£ç¡®"
        echo "  â€¢ æ£€æŸ¥ /etc/ssh/sshd_configï¼š"
        echo "    PasswordAuthentication yes"
        echo "    PermitRootLogin yes"
        echo "  â€¢ æŸ¥çœ‹è¿œç¨‹æ—¥å¿—: tail -f /var/log/auth.log"
        echo ""
        rm -f "$temp_script"
        return 1
    fi
}

###########################################
# æ¸…ç†ç­–ç•¥è·¯ç”±å‡½æ•°
###########################################

clean_policy_routing() {
    check_root
    
    print_header "æ¸…ç©ºç­–ç•¥è·¯ç”±é…ç½®"
    
    echo -e "${YELLOW}è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºä»¥ä¸‹é…ç½®ï¼š${NC}"
    echo "  â€¢ ix_return è·¯ç”±è¡¨"
    echo "  â€¢ ç­–ç•¥è·¯ç”±è§„åˆ™"
    echo "  â€¢ iptables mangle è§„åˆ™"
    echo ""
    
    read -p "ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ(yes/no) [no]: " confirm
    confirm=${confirm:-no}
    
    if [ "$confirm" != "yes" ]; then
        log_warn "æ“ä½œå·²å–æ¶ˆ"
        return 0
    fi
    
    echo ""
    log_step "å¼€å§‹æ¸…ç†..."
    
    log_info "æ¸…ç©º ix_return è·¯ç”±è¡¨..."
    ip route flush table ix_return 2>/dev/null
    
    log_info "åˆ é™¤ç­–ç•¥è·¯ç”±è§„åˆ™..."
    while ip rule list | grep -q "100:"; do
        ip rule del priority 100 2>/dev/null
    done
    while ip rule list | grep -q "99:"; do
        ip rule del priority 99 2>/dev/null
    done
    
    log_info "æ¸…ç©º iptables mangle è§„åˆ™..."
    iptables -t mangle -F 2>/dev/null
    
    log_info "åˆ·æ–°è·¯ç”±ç¼“å­˜..."
    ip route flush cache 2>/dev/null
    
    save_iptables
    
    echo ""
    log_info "âœ… æ¸…ç†å®Œæˆï¼"
}

###########################################
# äº¤äº’å¼é…ç½®ä¸»æµç¨‹
###########################################

interactive_setup() {
    check_root
    
    print_header "Halocloud IX SNAT + ç­–ç•¥è·¯ç”±é…ç½®è„šæœ¬ v2.3"
    
    check_interface "$INTERNAL_IF"
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    log_info "æœ¬æœº ens20 IP: $LOCAL_ENS20_IP"
    log_info "æ­¤ IP å°†ä½œä¸º IX ç«¯ ens20 çš„ç½‘å…³"
    
    echo ""
    log_step "æ­¥éª¤ 1/3: é…ç½®è¿œç¨‹ IX æœåŠ¡å™¨"
    echo ""
    
    read -p "è¯·è¾“å…¥ IX æœåŠ¡å™¨çš„ IP åœ°å€: " IX_SERVER_IP
    if [ -z "$IX_SERVER_IP" ]; then
        log_error "IP åœ°å€ä¸èƒ½ä¸ºç©ºï¼"
        exit 1
    fi
    
    if ! validate_ip "$IX_SERVER_IP"; then
        log_error "æ— æ•ˆçš„ IP åœ°å€æ ¼å¼ï¼"
        exit 1
    fi
    
    # ç½‘ç»œè¿é€šæ€§æ£€æŸ¥
    if ! check_network_connectivity "$IX_SERVER_IP"; then
        log_error "ç½‘ç»œè¿é€šæ€§æ£€æŸ¥å¤±è´¥ï¼Œæ— æ³•ç»§ç»­"
        exit 1
    fi
    
    # è·å–å¯†ç 
    IX_SERVER_PASSWORD=$(get_ssh_password "$IX_SERVER_IP")
    if [ $? -ne 0 ] || [ -z "$IX_SERVER_PASSWORD" ]; then
        log_error "å¯†ç è¾“å…¥å¤±è´¥"
        exit 1
    fi
    
    ALLOWED_IPS+=("$IX_SERVER_IP")
    log_info "âœ… IX IP $IX_SERVER_IP å·²è‡ªåŠ¨æ·»åŠ åˆ°å…è®¸åˆ—è¡¨"
    
    echo ""
    log_step "æ­¥éª¤ 2/3: é…ç½®å…è®¸è½¬å‘çš„ IP åœ°å€"
    echo ""
    
    echo ""
    log_step "æ­¥éª¤ 3/3: ç¡®è®¤é…ç½®"
    echo ""
    echo -e "${CYAN}é…ç½®æ‘˜è¦:${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "  ${YELLOW}æœ¬æœº (SNAT æœåŠ¡å™¨):${NC}"
    echo "    ens20 IP: $LOCAL_ENS20_IP"
    echo "    ens18: $(get_external_ip 2>/dev/null || echo 'å¾…æ£€æµ‹')"
    echo ""
    echo -e "  ${YELLOW}è¿œç¨‹ IX æœåŠ¡å™¨:${NC}"
    echo "    IP: $IX_SERVER_IP"
    echo "    ens20 ç½‘å…³: ${GREEN}$LOCAL_ENS20_IP${NC}"
    echo "    DNS: 1.1.1.1, 8.8.8.8"
    echo ""
    echo -e "  ${YELLOW}å…è®¸è½¬å‘çš„ IP:${NC}"
    for ip in "${ALLOWED_IPS[@]}"; do
        if [ "$ip" == "$IX_SERVER_IP" ]; then
            echo "    â€¢ $ip ${GREEN}(IX Server)${NC}"
        else
            echo "    â€¢ $ip"
        fi
    done
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    read -p "ç¡®è®¤å¼€å§‹é…ç½®ï¼Ÿ(yes/no) [yes]: " confirm
    confirm=${confirm:-yes}
    
    if [ "$confirm" != "yes" ]; then
        log_warn "é…ç½®å·²å–æ¶ˆ"
        exit 0
    fi
    
    echo ""
    print_header "å¼€å§‹æ‰§è¡Œé…ç½®"
    
    echo ""
    log_step "ã€é˜¶æ®µ 1/2ã€‘é…ç½®æœ¬åœ° SNAT..."
    echo ""
    init_snat
    save_iptables
    
    show_snat_summary
    
    echo ""
    log_step "ã€é˜¶æ®µ 2/2ã€‘é…ç½®è¿œç¨‹ç­–ç•¥è·¯ç”±..."
    echo ""
    
    if configure_remote_policy_routing "$IX_SERVER_IP" "$IX_SERVER_PASSWORD" "$LOCAL_ENS20_IP"; then
        print_header "ğŸ‰ å…¨éƒ¨é…ç½®å®Œæˆï¼"
        echo ""
        echo -e "${GREEN}âœ… æœ¬åœ° SNAT é…ç½®æˆåŠŸ${NC}"
        echo -e "${GREEN}âœ… è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®æˆåŠŸ${NC}"
        echo -e "${GREEN}âœ… æ‰€æœ‰é…ç½®å·²æŒä¹…åŒ–${NC}"
        echo ""
        echo -e "${YELLOW}éªŒè¯å‘½ä»¤ (åœ¨ IX ç«¯):${NC}"
        echo "  â€¢ ping $LOCAL_ENS20_IP"
        echo "  â€¢ nslookup google.com"
        echo "  â€¢ ip route"
        echo ""
    else
        echo ""
        log_warn "æœ¬åœ° SNAT é…ç½®æˆåŠŸï¼Œä½†è¿œç¨‹é…ç½®å¤±è´¥"
        echo ""
        echo -e "${YELLOW}å¯ä»¥ç¨åæ‰‹åŠ¨åœ¨ IX ç«¯æ‰§è¡Œï¼š${NC}"
        echo "  1. è®¾ç½® ens20 ç½‘å…³: ip route add default via $LOCAL_ENS20_IP dev ens20"
        echo "  2. é…ç½® DNS: echo 'nameserver 1.1.1.1' > /etc/resolv.conf"
        echo ""
    fi
}

###########################################
# å…¶ä»–å‘½ä»¤å¤„ç†
###########################################

handle_add_ip() {
    check_root
    if [ -z "$1" ]; then
        log_error "è¯·æŒ‡å®š IP åœ°å€"
        exit 1
    fi
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    add_allowed_ip "$1"
    save_iptables
}

handle_del_ip() {
    check_root
    if [ -z "$1" ]; then
        log_error "è¯·æŒ‡å®š IP åœ°å€"
        exit 1
    fi
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    if iptables -C FORWARD -s "$1" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT 2>/dev/null; then
        iptables -D FORWARD -s "$1" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT
        log_info "âœ… å·²åˆ é™¤ $1"
        save_iptables
    else
        log_warn "IP $1 ä¸åœ¨åˆ—è¡¨ä¸­"
    fi
}

handle_list() {
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    print_header "å…è®¸è½¬å‘çš„ IP åˆ—è¡¨"
    echo -e "${BLUE}æœ¬æœº:${NC} $(get_internal_ip) (ens20) â†’ $(get_external_ip) (ens18)"
    echo ""
    local rules=$(iptables -L FORWARD -n -v --line-numbers | grep "$EXTERNAL_IF" | grep ACCEPT | grep -v "RELATED,ESTABLISHED")
    if [ -z "$rules" ]; then
        log_warn "æ— é…ç½®"
    else
        echo "$rules" | awk '{printf "%-6s%s\n", $1, $8}'
    fi
    echo ""
}

show_help() {
    cat << EOF
${GREEN}SNAT + ç­–ç•¥è·¯ç”±é…ç½®è„šæœ¬ (ç®€åŒ–ç‰ˆ)${NC}

${YELLOW}å‘½ä»¤:${NC}
    $0              # é…ç½®å‘å¯¼
    $0 add <IP>     # æ·»åŠ  IP
    $0 del <IP>     # åˆ é™¤ IP
    $0 list         # åˆ—è¡¨
    $0 clean        # æ¸…ç©º
    $0 help         # å¸®åŠ©
EOF
}

###########################################
# ä¸»å‡½æ•°
###########################################

main() {
    case "${1:-setup}" in
        setup|init|config|configure)
            interactive_setup
            ;;
        add)
            handle_add_ip "$2"
            ;;
        del|delete|remove)
            handle_del_ip "$2"
            ;;
        list|ls|show)
            handle_list
            ;;
        clean|clear|reset)
            clean_policy_routing
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            interactive_setup
            ;;
    esac
}

main "$@"
