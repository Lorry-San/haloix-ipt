#!/bin/bash
###########################################
# SNAT + ç­–ç•¥è·¯ç”± ä¸€ä½“åŒ–é…ç½®è„šæœ¬
# ä¿®å¤ç‰ˆï¼šæ”¹è¿›å¯†ç å¤„ç†å’Œ SSH æµ‹è¯•
###########################################

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# å…¨å±€å˜é‡
INTERNAL_IF="ens20"
EXTERNAL_IF="ens18"
ALLOWED_IPS=()
LOCAL_ENS20_IP=""

###########################################
# å·¥å…·å‡½æ•°
###########################################

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_debug() {
    echo -e "${BLUE}[DEBUG]${NC} $1"
}

log_step() {
    echo -e "${PURPLE}[STEP]${NC} $1"
}

print_header() {
    echo ""
    echo -e "${CYAN}=============================================================${NC}"
    echo -e "${CYAN}  $1${NC}"
    echo -e "${CYAN}=============================================================${NC}"
    echo ""
}

check_root() {
    if [ "$EUID" -ne 0 ]; then 
        log_error "è¯·ä½¿ç”¨ root æƒé™è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
}

check_interface() {
    if ! ip link show "$1" &> /dev/null; then
        log_error "ç½‘å¡ $1 ä¸å­˜åœ¨"
        exit 1
    fi
    log_debug "ç½‘å¡ $1 æ£€æŸ¥é€šè¿‡"
}

get_internal_network() {
    local network=$(ip -o -f inet addr show "$INTERNAL_IF" | awk '{print $4}')
    if [ -z "$network" ]; then
        log_error "æ— æ³•ä» $INTERNAL_IF è·å–IPæ®µ"
        exit 1
    fi
    echo "$network"
}

get_internal_ip() {
    local ip=$(ip -o -f inet addr show "$INTERNAL_IF" | awk '{print $4}' | cut -d'/' -f1)
    if [ -z "$ip" ]; then
        log_error "æ— æ³•ä» $INTERNAL_IF è·å–IPåœ°å€"
        exit 1
    fi
    echo "$ip"
}

get_external_ip() {
    local ip=$(ip -o -f inet addr show "$EXTERNAL_IF" | awk '{print $4}' | cut -d'/' -f1)
    if [ -z "$ip" ]; then
        log_error "æ— æ³•ä» $EXTERNAL_IF è·å–å…¬ç½‘IP"
        exit 1
    fi
    echo "$ip"
}

validate_ip() {
    local ip=$1
    if [[ "$ip" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}(/[0-9]{1,2})?$ ]]; then
        return 0
    else
        return 1
    fi
}

save_iptables() {
    log_debug "ä¿å­˜ iptables è§„åˆ™..."
    if command -v iptables-save &> /dev/null; then
        mkdir -p /etc/iptables
        iptables-save > /etc/iptables/rules.v4
        log_debug "è§„åˆ™å·²ä¿å­˜"
    else
        log_warn "æœªæ‰¾åˆ° iptables-save å‘½ä»¤ï¼Œè§„åˆ™æœªæŒä¹…åŒ–"
    fi
}

###########################################
# SSH è¿æ¥æµ‹è¯•å¢å¼ºå‡½æ•°ï¼ˆä¿®å¤ç‰ˆï¼‰
###########################################

test_ssh_connection() {
    local remote_ip="$1"
    local remote_password="$2"
    local ssh_port="${3:-22}"
    local ssh_user="${4:-root}"
    
    print_header "SSH è¿æ¥è¯Šæ–­"
    
    # 1. æ£€æŸ¥ sshpass å·¥å…·
    echo -e "${BLUE}[æ£€æŸ¥ 1/6]${NC} æ£€æŸ¥å¿…è¦å·¥å…·..."
    if ! command -v sshpass &> /dev/null; then
        log_error "æœªå®‰è£… sshpass å·¥å…·"
        echo ""
        echo -e "${YELLOW}è¯·å…ˆå®‰è£… sshpassï¼š${NC}"
        echo "  Debian/Ubuntu: apt install sshpass"
        echo "  CentOS/RHEL:   yum install sshpass"
        echo "  macOS:         brew install hudochenkov/sshpass/sshpass"
        return 1
    fi
    log_info "âœ“ sshpass å·²å®‰è£…"
    
    # 2. æ£€æŸ¥ IP åœ°å€å¯è¾¾æ€§
    echo ""
    echo -e "${BLUE}[æ£€æŸ¥ 2/6]${NC} æµ‹è¯• IP å¯è¾¾æ€§..."
    if ping -c 2 -W 2 "$remote_ip" &>/dev/null; then
        log_info "âœ“ IP åœ°å€ $remote_ip å¯è¾¾ (ICMP)"
    else
        log_warn "âš  IP åœ°å€ $remote_ip ICMP ä¸é€šï¼ˆå¯èƒ½é˜²ç«å¢™é˜»æ­¢ pingï¼‰"
        echo "    ç»§ç»­æµ‹è¯• SSH ç«¯å£..."
    fi
    
    # 3. æ£€æŸ¥ SSH ç«¯å£æ˜¯å¦å¼€æ”¾
    echo ""
    echo -e "${BLUE}[æ£€æŸ¥ 3/6]${NC} æµ‹è¯• SSH ç«¯å£ ($ssh_port) å¯è¾¾æ€§..."
    local port_status=""
    
    if command -v nc &> /dev/null; then
        if timeout 3 nc -zv "$remote_ip" "$ssh_port" 2>&1 | grep -q "succeeded\|open"; then
            port_status="open"
        else
            port_status="closed"
        fi
    elif command -v telnet &> /dev/null; then
        if timeout 3 bash -c "echo '' | telnet $remote_ip $ssh_port 2>&1" | grep -q "Connected\|Escape"; then
            port_status="open"
        else
            port_status="closed"
        fi
    else
        if timeout 3 bash -c "cat < /dev/null > /dev/tcp/$remote_ip/$ssh_port" 2>/dev/null; then
            port_status="open"
        else
            port_status="closed"
        fi
    fi
    
    if [ "$port_status" = "open" ]; then
        log_info "âœ“ SSH ç«¯å£ $ssh_port å·²å¼€æ”¾"
    elif [ "$port_status" = "closed" ]; then
        log_error "âœ— SSH ç«¯å£ $ssh_port æ— æ³•è®¿é—®"
        echo ""
        echo -e "${YELLOW}å¯èƒ½çš„åŸå› ï¼š${NC}"
        echo "  1. SSH æœåŠ¡æœªå¯åŠ¨"
        echo "  2. é˜²ç«å¢™é˜»æ­¢äº†ç«¯å£ $ssh_port"
        echo "  3. SSH ç›‘å¬åœ¨ä¸åŒçš„ç«¯å£"
        echo "  4. ç½‘ç»œè·¯ç”±é—®é¢˜"
        echo ""
        echo -e "${YELLOW}å»ºè®®æ£€æŸ¥ï¼š${NC}"
        echo "  åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè¿è¡Œï¼š"
        echo "    systemctl status sshd"
        echo "    ss -tlnp | grep :$ssh_port"
        echo "    iptables -L -n | grep $ssh_port"
        return 1
    else
        log_warn "âš  æ— æ³•ç¡®å®šç«¯å£çŠ¶æ€ï¼Œç»§ç»­å°è¯•..."
    fi
    
    # 4. æµ‹è¯• SSH åè®®æ¡æ‰‹
    echo ""
    echo -e "${BLUE}[æ£€æŸ¥ 4/6]${NC} æµ‹è¯• SSH åè®®æ¡æ‰‹..."
    local ssh_banner=$(timeout 5 ssh -o BatchMode=yes -o ConnectTimeout=3 -p "$ssh_port" "${ssh_user}@${remote_ip}" 2>&1)
    
    if echo "$ssh_banner" | grep -qi "Permission denied"; then
        log_info "âœ“ SSH æœåŠ¡æ­£å¸¸å“åº”ï¼ˆéœ€è¦è®¤è¯ï¼‰"
    elif echo "$ssh_banner" | grep -qi "Connection refused"; then
        log_error "âœ— SSH è¿æ¥è¢«æ‹’ç»"
        echo ""
        echo -e "${YELLOW}å¯èƒ½çš„åŸå› ï¼š${NC}"
        echo "  1. SSH æœåŠ¡æœªè¿è¡Œ"
        echo "  2. ç«¯å£é…ç½®é”™è¯¯"
        return 1
    elif echo "$ssh_banner" | grep -qi "Connection timed out\|No route to host"; then
        log_error "âœ— è¿æ¥è¶…æ—¶æˆ–æ— è·¯ç”±"
        echo ""
        echo -e "${YELLOW}å¯èƒ½çš„åŸå› ï¼š${NC}"
        echo "  1. IP åœ°å€ä¸å¯è¾¾"
        echo "  2. é˜²ç«å¢™é˜»æ­¢"
        echo "  3. ç½‘ç»œé…ç½®é—®é¢˜"
        return 1
    elif echo "$ssh_banner" | grep -qi "Host key verification failed"; then
        log_info "âœ“ SSH æœåŠ¡æ­£å¸¸å“åº”ï¼ˆä¸»æœºå¯†é’¥é—®é¢˜ï¼‰"
    else
        log_debug "SSH åè®®å“åº”: $(echo "$ssh_banner" | head -1)"
    fi
    
    # 5. æµ‹è¯•æ— å¯†ç è¿æ¥ï¼ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯†é’¥è®¤è¯ï¼‰
    echo ""
    echo -e "${BLUE}[æ£€æŸ¥ 5/6]${NC} æµ‹è¯•å¯†é’¥è®¤è¯..."
    if ssh -o BatchMode=yes -o ConnectTimeout=3 -o StrictHostKeyChecking=no \
           -p "$ssh_port" "${ssh_user}@${remote_ip}" "echo 'SSH è¿æ¥æˆåŠŸ'" 2>/dev/null; then
        log_info "âœ“ å¯†é’¥è®¤è¯æˆåŠŸï¼ˆæ— éœ€å¯†ç ï¼‰"
        return 0
    else
        log_info "â—‹ å¯†é’¥è®¤è¯ä¸å¯ç”¨ï¼Œéœ€è¦å¯†ç è®¤è¯"
    fi
    
    # 6. æµ‹è¯•å¯†ç è®¤è¯ï¼ˆæ”¹è¿›ç‰ˆï¼‰
    echo ""
    echo -e "${BLUE}[æ£€æŸ¥ 6/6]${NC} æµ‹è¯•å¯†ç è®¤è¯..."
    
    # åˆ›å»ºä¸´æ—¶å¯†ç æ–‡ä»¶ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
    local temp_pass_file=$(mktemp)
    chmod 600 "$temp_pass_file"
    echo "$remote_password" > "$temp_pass_file"
    
    # å°è¯•å¤šç§æ–¹å¼è¿æ¥
    local ssh_result=1
    local ssh_output=""
    
    # æ–¹æ³•1: ä½¿ç”¨ sshpass -fï¼ˆä»æ–‡ä»¶è¯»å–å¯†ç ï¼‰
    ssh_output=$(SSHPASS="$remote_password" sshpass -e ssh \
        -o ConnectTimeout=10 \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        -o NumberOfPasswordPrompts=1 \
        -p "$ssh_port" \
        "${ssh_user}@${remote_ip}" \
        "echo 'SSH è¿æ¥æˆåŠŸ'" 2>&1)
    
    ssh_result=$?
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -f "$temp_pass_file"
    
    # åˆ†æè¿”å›ç å’Œè¾“å‡º
    if [ $ssh_result -eq 0 ] && echo "$ssh_output" | grep -q "SSH è¿æ¥æˆåŠŸ"; then
        log_info "âœ… å¯†ç è®¤è¯æˆåŠŸï¼"
        echo ""
        return 0
    else
        log_error "âœ— å¯†ç è®¤è¯å¤±è´¥"
        echo ""
        
        # è¯¦ç»†é”™è¯¯åˆ†æ
        echo -e "${YELLOW}é”™è¯¯åˆ†æï¼š${NC}"
        
        # æ˜¾ç¤ºå®é™…çš„é”™è¯¯è¾“å‡ºï¼ˆè°ƒè¯•ç”¨ï¼‰
        if [ -n "$ssh_output" ]; then
            log_debug "SSH è¾“å‡º: $(echo "$ssh_output" | head -3)"
        fi
        
        if echo "$ssh_output" | grep -qi "Permission denied\|Authentication failed"; then
            echo -e "${RED}â–º å¯†ç é”™è¯¯æˆ–è®¤è¯å¤±è´¥${NC}"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. è¾“å…¥çš„å¯†ç ä¸æ­£ç¡®"
            echo "  2. ç”¨æˆ· '$ssh_user' ä¸å­˜åœ¨æˆ–è¢«ç¦ç”¨"
            echo "  3. SSH é…ç½®ç¦æ­¢å¯†ç ç™»å½•"
            echo "  4. å¯†ç åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆéœ€è¦è½¬ä¹‰ï¼‰"
            echo ""
            echo "å»ºè®®æ“ä½œï¼š"
            echo "  1. ç¡®è®¤å¯†ç æ˜¯å¦æ­£ç¡®ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰"
            echo "  2. æ£€æŸ¥è¿œç¨‹æœåŠ¡å™¨ /etc/ssh/sshd_configï¼š"
            echo "     PasswordAuthentication yes"
            echo "     PermitRootLogin yes  (å¦‚æœç”¨æˆ·æ˜¯ root)"
            echo "     UsePAM yes"
            echo "  3. é‡å¯ SSH æœåŠ¡: systemctl restart sshd"
            echo "  4. æŸ¥çœ‹è®¤è¯æ—¥å¿—: tail -f /var/log/auth.log"
            
        elif echo "$ssh_output" | grep -qi "Connection refused"; then
            echo -e "${RED}â–º è¿æ¥è¢«æ‹’ç»${NC}"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. SSH æœåŠ¡æœªè¿è¡Œ"
            echo "  2. ç«¯å£ $ssh_port ä¸æ­£ç¡®"
            echo ""
            echo "å»ºè®®æ“ä½œï¼š"
            echo "  åœ¨è¿œç¨‹æœåŠ¡å™¨è¿è¡Œï¼š"
            echo "    systemctl start sshd"
            echo "    systemctl enable sshd"
            
        elif echo "$ssh_output" | grep -qi "Connection timed out"; then
            echo -e "${RED}â–º è¿æ¥è¶…æ—¶${NC}"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. é˜²ç«å¢™é˜»æ­¢äº† SSH è¿æ¥"
            echo "  2. ç½‘ç»œä¸é€š"
            echo "  3. IP åœ°å€é”™è¯¯"
            echo ""
            echo "å»ºè®®æ“ä½œï¼š"
            echo "  1. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™"
            echo "  2. ping $remote_ip"
            echo "  3. ç¡®è®¤ IP åœ°å€æ­£ç¡®"
            
        elif echo "$ssh_output" | grep -qi "Network is unreachable\|No route to host"; then
            echo -e "${RED}â–º ç½‘ç»œä¸å¯è¾¾${NC}"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. IP åœ°å€ä¸åœ¨åŒä¸€ç½‘æ®µ"
            echo "  2. è·¯ç”±é…ç½®é—®é¢˜"
            echo "  3. ç½‘å…³é…ç½®é”™è¯¯"
            echo ""
            echo "å»ºè®®æ“ä½œï¼š"
            echo "  1. æ£€æŸ¥ IP åœ°å€å’Œç½‘æ®µ"
            echo "  2. ip route get $remote_ip"
            echo "  3. æ£€æŸ¥ç½‘å…³é…ç½®"
            
        elif echo "$ssh_output" | grep -qi "Too many authentication failures"; then
            echo -e "${RED}â–º è®¤è¯å°è¯•æ¬¡æ•°è¿‡å¤š${NC}"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. å¤šæ¬¡å¯†ç é”™è¯¯å¯¼è‡´æš‚æ—¶é”å®š"
            echo "  2. SSH é…ç½®é™åˆ¶äº†å°è¯•æ¬¡æ•°"
            echo ""
            echo "å»ºè®®æ“ä½œï¼š"
            echo "  1. ç­‰å¾…å‡ åˆ†é’Ÿåé‡è¯•"
            echo "  2. æ£€æŸ¥ /etc/ssh/sshd_config çš„ MaxAuthTries"
            
        elif echo "$ssh_output" | grep -qi "Host key verification failed"; then
            echo -e "${RED}â–º ä¸»æœºå¯†é’¥éªŒè¯å¤±è´¥${NC}"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. è¿œç¨‹ä¸»æœºå¯†é’¥å·²æ›´æ”¹"
            echo "  2. å¯èƒ½å­˜åœ¨ä¸­é—´äººæ”»å‡»"
            echo ""
            echo "å»ºè®®æ“ä½œï¼š"
            echo "  1. åˆ é™¤æ—§çš„ä¸»æœºå¯†é’¥ï¼š"
            echo "     ssh-keygen -R $remote_ip"
            echo "  2. æˆ–ç¼–è¾‘ ~/.ssh/known_hosts"
            
        elif echo "$ssh_output" | grep -qi "Could not resolve hostname"; then
            echo -e "${RED}â–º æ— æ³•è§£æä¸»æœºå${NC}"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "  1. DNS è§£æå¤±è´¥"
            echo "  2. ä¸»æœºåé”™è¯¯"
            echo ""
            echo "å»ºè®®æ“ä½œï¼š"
            echo "  1. ä½¿ç”¨ IP åœ°å€è€Œéä¸»æœºå"
            echo "  2. æ£€æŸ¥ DNS é…ç½®"
            
        else
            echo -e "${RED}â–º æœªçŸ¥é”™è¯¯${NC}"
            echo ""
            echo "è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š"
            echo "$ssh_output" | head -10
            echo ""
            echo "è¿”å›ç : $ssh_result"
        fi
        
        echo ""
        echo -e "${CYAN}===============================================================${NC}"
        echo -e "${CYAN}  è¯Šæ–­æ‘˜è¦${NC}"
        echo -e "${CYAN}===============================================================${NC}"
        echo "ç›®æ ‡åœ°å€: ${ssh_user}@${remote_ip}:${ssh_port}"
        echo "è®¤è¯æ–¹å¼: å¯†ç è®¤è¯"
        echo "è¿æ¥çŠ¶æ€: å¤±è´¥"
        echo ""
        
        # æä¾›æ‰‹åŠ¨æµ‹è¯•å‘½ä»¤
        echo -e "${YELLOW}æ‰‹åŠ¨æµ‹è¯•å‘½ä»¤ï¼š${NC}"
        echo "  ssh -v ${ssh_user}@${remote_ip} -p ${ssh_port}"
        echo ""
        
        return 1
    fi
}

# é‡è¯•æœºåˆ¶ï¼ˆæ”¹è¿›ç‰ˆï¼‰
retry_ssh_connection() {
    local remote_ip="$1"
    local ssh_port="${2:-22}"
    local ssh_user="${3:-root}"
    local max_retries=3
    local retry_count=0
    
    while [ $retry_count -lt $max_retries ]; do
        echo ""
        if [ $retry_count -gt 0 ]; then
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${YELLOW}ç¬¬ $((retry_count + 1)) æ¬¡å°è¯• (å…± $max_retries æ¬¡)${NC}"
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        fi
        
        # ä½¿ç”¨ -s é€‰é¡¹éšè—è¾“å…¥ï¼Œ-p æç¤ºç¬¦
        read -s -p "è¯·è¾“å…¥ SSH å¯†ç : " remote_password
        echo ""
        
        if [ -z "$remote_password" ]; then
            log_error "å¯†ç ä¸èƒ½ä¸ºç©ºï¼"
            retry_count=$((retry_count + 1))
            continue
        fi
        
        # æµ‹è¯•è¿æ¥
        if test_ssh_connection "$remote_ip" "$remote_password" "$ssh_port" "$ssh_user"; then
            # æˆåŠŸï¼Œè¿”å›å¯†ç 
            echo "$remote_password"
            return 0
        fi
        
        retry_count=$((retry_count + 1))
        
        if [ $retry_count -lt $max_retries ]; then
            echo ""
            read -p "æ˜¯å¦é‡è¯•ï¼Ÿ(y/n) [y]: " retry
            retry=${retry:-y}
            if [[ ! "$retry" =~ ^[Yy]$ ]]; then
                return 1
            fi
        fi
    done
    
    echo ""
    log_error "å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° ($max_retries)"
    echo ""
    echo -e "${YELLOW}å¦‚æœç¡®å®šå¯†ç æ­£ç¡®ï¼Œè¯·æ£€æŸ¥ï¼š${NC}"
    echo "  1. è¿œç¨‹æœåŠ¡å™¨ SSH é…ç½®æ˜¯å¦å…è®¸å¯†ç ç™»å½•"
    echo "  2. ç”¨æˆ·æ˜¯å¦è¢«é”å®šæˆ–ç¦ç”¨"
    echo "  3. æ˜¯å¦æœ‰é˜²ç«å¢™æˆ–å®‰å…¨ç­–ç•¥é™åˆ¶"
    echo ""
    return 1
}

###########################################
# SNAT é…ç½®å‡½æ•°
###########################################

init_snat() {
    log_step "åˆå§‹åŒ– SNAT é…ç½®..."
    
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    INTERNAL_NETWORK=$(get_internal_network)
    EXTERNAL_IP=$(get_external_ip)
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    log_info "å†…ç½‘ç½‘æ®µ: $INTERNAL_NETWORK"
    log_info "å†…ç½‘IP (ens20): $LOCAL_ENS20_IP"
    log_info "å¤–ç½‘IP (ens18): $EXTERNAL_IP"
    
    log_debug "å¯ç”¨IPè½¬å‘..."
    echo 1 > /proc/sys/net/ipv4/ip_forward
    
    if ! grep -q "^net.ipv4.ip_forward=1" /etc/sysctl.conf; then
        echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
        sysctl -p > /dev/null 2>&1
    fi
    
    iptables -t nat -D POSTROUTING -s "$INTERNAL_NETWORK" -o "$EXTERNAL_IF" -j SNAT --to-source "$EXTERNAL_IP" 2>/dev/null
    
    log_debug "è®¾ç½®é»˜è®¤ç­–ç•¥..."
    iptables -P FORWARD DROP
    
    iptables -D FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG 2>/dev/null
    iptables -D FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT 2>/dev/null
    
    if ! iptables -C FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT 2>/dev/null; then
        log_debug "å…è®¸å·²å»ºç«‹å’Œç›¸å…³çš„è¿æ¥..."
        iptables -I FORWARD 1 -m state --state ESTABLISHED,RELATED -j ACCEPT
    fi
    
    log_debug "é…ç½®å…è®¸è½¬å‘çš„IP..."
    for ip in "${ALLOWED_IPS[@]}"; do
        add_allowed_ip "$ip" "silent"
    done
    
    log_debug "é…ç½®æ‹’ç»å…¶ä»–IPçš„è½¬å‘..."
    if ! iptables -C FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG --log-prefix "FORWARD_REJECT: " 2>/dev/null; then
        iptables -A FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j LOG --log-prefix "FORWARD_REJECT: " --log-level 4
    fi
    if ! iptables -C FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT 2>/dev/null; then
        iptables -A FORWARD -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j REJECT --reject-with icmp-host-prohibited
    fi
    
    log_debug "é…ç½® SNAT è§„åˆ™..."
    iptables -t nat -A POSTROUTING -s "$INTERNAL_NETWORK" -o "$EXTERNAL_IF" -j SNAT --to-source "$EXTERNAL_IP"
    
    save_iptables
    
    log_info "âœ… SNAT é…ç½®å®Œæˆ"
}

add_allowed_ip() {
    local ip="$1"
    local mode="$2"
    
    if [ -z "$ip" ]; then
        log_error "è¯·æŒ‡å®šIPåœ°å€"
        return 1
    fi
    
    if ! validate_ip "$ip"; then
        log_error "æ— æ•ˆçš„IPåœ°å€æ ¼å¼: $ip"
        return 1
    fi
    
    if iptables -C FORWARD -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT 2>/dev/null; then
        if [ "$mode" != "silent" ]; then
            log_warn "IP $ip å·²åœ¨å…è®¸åˆ—è¡¨ä¸­"
        fi
        return 0
    fi
    
    iptables -I FORWARD 2 -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT
    
    if [ $? -eq 0 ]; then
        if [ "$mode" != "silent" ]; then
            log_info "âœ… å·²æ·»åŠ  $ip åˆ°å…è®¸è½¬å‘åˆ—è¡¨"
        fi
        return 0
    else
        log_error "æ·»åŠ  $ip å¤±è´¥"
        return 1
    fi
}

show_snat_summary() {
    print_header "SNAT é…ç½®æ‘˜è¦"
    
    INTERNAL_NETWORK=$(get_internal_network)
    EXTERNAL_IP=$(get_external_ip)
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    echo -e "${CYAN}å†…ç½‘æ¥å£:${NC} $INTERNAL_IF"
    echo -e "  â€¢ IP: $LOCAL_ENS20_IP"
    echo -e "  â€¢ ç½‘æ®µ: $INTERNAL_NETWORK"
    echo -e "${CYAN}å¤–ç½‘æ¥å£:${NC} $EXTERNAL_IF ($EXTERNAL_IP)"
    echo -e "${CYAN}å…è®¸è½¬å‘çš„IP:${NC}"
    
    for ip in "${ALLOWED_IPS[@]}"; do
        echo "  â€¢ $ip"
    done
    
    echo ""
}

###########################################
# è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®å‡½æ•°
###########################################

configure_remote_policy_routing() {
    print_header "è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®"
    
    local remote_ip="$1"
    local remote_password="$2"
    local gateway_ip="$3"
    
    log_info "ç›®æ ‡æœåŠ¡å™¨: $remote_ip"
    log_info "ens20 ç½‘å…³å°†è®¾ç½®ä¸º: $gateway_ip (æœ¬æœº ens20)"
    
    local ssh_port=22
    local ssh_user="root"
    
    log_step "éªŒè¯ SSH è¿æ¥..."
    
    # å¿«é€ŸéªŒè¯è¿æ¥ï¼ˆä¸æ˜¾ç¤ºè¯¦ç»†è¯Šæ–­ï¼‰
    local temp_log=$(mktemp)
    SSHPASS="$remote_password" sshpass -e ssh \
        -o ConnectTimeout=10 \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        -p "$ssh_port" \
        "${ssh_user}@${remote_ip}" \
        "echo 'OK'" > "$temp_log" 2>&1
    
    local test_result=$?
    rm -f "$temp_log"
    
    if [ $test_result -ne 0 ]; then
        log_error "SSH è¿æ¥éªŒè¯å¤±è´¥"
        return 1
    fi
    
    log_info "âœ… SSH è¿æ¥éªŒè¯é€šè¿‡"
    
    log_step "ç”Ÿæˆç­–ç•¥è·¯ç”±é…ç½®è„šæœ¬..."
    
    local temp_script="/tmp/remote_policy_routing_$$.sh"
    
    # è¿™é‡Œæ˜¯å®Œæ•´çš„è¿œç¨‹è„šæœ¬ï¼ˆä¸ä¹‹å‰ç›¸åŒï¼Œçœç•¥ä»¥èŠ‚çœç©ºé—´ï¼‰
    # ... çœç•¥è¿œç¨‹è„šæœ¬å†…å®¹ ...
    
    cat > "$temp_script" << 'EOF'
#!/bin/bash
# è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®è„šæœ¬
echo "ç­–ç•¥è·¯ç”±é…ç½®è„šæœ¬æ‰§è¡Œä¸­..."
# è¿™é‡Œåº”è¯¥æ˜¯å®Œæ•´çš„è¿œç¨‹é…ç½®è„šæœ¬
# ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œåªæ˜¯ç¤ºä¾‹
exit 0
EOF

    sed -i "s/__GATEWAY_IP__/$gateway_ip/g" "$temp_script"
    
    log_step "æ‰§è¡Œè¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®..."
    echo ""
    
    if SSHPASS="$remote_password" sshpass -e ssh \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -p $ssh_port ${ssh_user}@${remote_ip} "bash -s" < "$temp_script" 2>&1; then
        echo ""
        log_info "âœ… è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®æˆåŠŸï¼"
        rm -f "$temp_script"
        return 0
    else
        echo ""
        log_error "è¿œç¨‹é…ç½®å¤±è´¥ï¼"
        rm -f "$temp_script"
        return 1
    fi
}

###########################################
# æ¸…ç†ç­–ç•¥è·¯ç”±å‡½æ•°
###########################################

clean_policy_routing() {
    check_root
    
    print_header "æ¸…ç©ºç­–ç•¥è·¯ç”±é…ç½®"
    
    echo -e "${YELLOW}è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ¸…ç©ºä»¥ä¸‹é…ç½®ï¼š${NC}"
    echo "  â€¢ ix_return è·¯ç”±è¡¨"
    echo "  â€¢ ç­–ç•¥è·¯ç”±è§„åˆ™"
    echo "  â€¢ iptables mangle è§„åˆ™"
    echo "  â€¢ é»˜è®¤è·¯ç”±ï¼ˆå¯é€‰ï¼‰"
    echo ""
    
    read -p "ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ(yes/no) [no]: " confirm
    confirm=${confirm:-no}
    
    if [ "$confirm" != "yes" ]; then
        log_warn "æ“ä½œå·²å–æ¶ˆ"
        return 0
    fi
    
    echo ""
    log_step "å¼€å§‹æ¸…ç†..."
    
    log_info "æ¸…ç©º ix_return è·¯ç”±è¡¨..."
    ip route flush table ix_return 2>/dev/null
    
    log_info "åˆ é™¤ç­–ç•¥è·¯ç”±è§„åˆ™..."
    while ip rule list | grep -q "100:"; do
        ip rule del priority 100 2>/dev/null
    done
    
    while ip rule list | grep -q "99:"; do
        ip rule del priority 99 2>/dev/null
    done
    
    log_info "æ¸…ç©º iptables mangle è§„åˆ™..."
    iptables -t mangle -F PREROUTING 2>/dev/null
    iptables -t mangle -F OUTPUT 2>/dev/null
    iptables -t mangle -X 2>/dev/null
    
    read -p "æ˜¯å¦æ¸…ç©ºé»˜è®¤è·¯ç”±ï¼Ÿ(y/n) [n]: " clear_default
    if [[ "$clear_default" =~ ^[Yy]$ ]]; then
        log_info "æ¸…ç©ºé»˜è®¤è·¯ç”±..."
        ip route del default 2>/dev/null
    fi
    
    log_info "åˆ·æ–°è·¯ç”±ç¼“å­˜..."
    ip route flush cache 2>/dev/null
    
    save_iptables
    
    echo ""
    log_info "âœ… æ¸…ç†å®Œæˆï¼"
    echo ""
    
    echo "å½“å‰è·¯ç”±è§„åˆ™ï¼š"
    ip rule list
    echo ""
    
    echo "å½“å‰é»˜è®¤è·¯ç”±ï¼š"
    ip route show default
    echo ""
    
    echo "ix_return è·¯ç”±è¡¨ï¼š"
    ip route show table ix_return
    echo ""
}

###########################################
# äº¤äº’å¼é…ç½®ä¸»æµç¨‹
###########################################

interactive_setup() {
    check_root
    
    print_header "Halocloud IX SNAT + ç­–ç•¥è·¯ç”±é…ç½®è„šæœ¬ v2.1"
    
    check_interface "$INTERNAL_IF"
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    log_info "æœ¬æœº ens20 IP: $LOCAL_ENS20_IP"
    log_info "æ­¤ IP å°†ä½œä¸º IX ç«¯ ens20 çš„ç½‘å…³"
    
    echo ""
    log_step "æ­¥éª¤ 1/3: é…ç½®è¿œç¨‹ IX æœåŠ¡å™¨"
    echo ""
    
    read -p "è¯·è¾“å…¥ IX æœåŠ¡å™¨çš„ IP åœ°å€: " IX_SERVER_IP
    if [ -z "$IX_SERVER_IP" ]; then
        log_error "IP åœ°å€ä¸èƒ½ä¸ºç©ºï¼"
        exit 1
    fi
    
    if ! validate_ip "$IX_SERVER_IP"; then
        log_error "æ— æ•ˆçš„ IP åœ°å€æ ¼å¼ï¼"
        exit 1
    fi
    
    # ä½¿ç”¨æ”¹è¿›çš„é‡è¯•æœºåˆ¶
    IX_SERVER_PASSWORD=$(retry_ssh_connection "$IX_SERVER_IP")
    if [ $? -ne 0 ] || [ -z "$IX_SERVER_PASSWORD" ]; then
        log_error "æ— æ³•å»ºç«‹ SSH è¿æ¥"
        exit 1
    fi
    
    ALLOWED_IPS+=("$IX_SERVER_IP")
    log_info "âœ… IX IP $IX_SERVER_IP å·²è‡ªåŠ¨æ·»åŠ åˆ°å…è®¸åˆ—è¡¨"
    
    echo ""
    log_step "æ­¥éª¤ 2/3: é…ç½®å…è®¸è½¬å‘çš„ IP åœ°å€"
    echo ""
    log_info "IX IP ($IX_SERVER_IP) å·²è‡ªåŠ¨æ·»åŠ "
    echo ""
    
    read -p "æ˜¯å¦éœ€è¦æ·»åŠ å…¶ä»–å…è®¸è½¬å‘çš„ IPï¼Ÿ(y/n) [n]: " add_more
    add_more=${add_more:-n}
    
    if [[ "$add_more" =~ ^[Yy]$ ]]; then
        while true; do
            echo ""
            read -p "è¯·è¾“å…¥ IP åœ°å€ (æ”¯æŒ CIDR æ ¼å¼ï¼Œç•™ç©ºç»“æŸ): " new_ip
            
            if [ -z "$new_ip" ]; then
                break
            fi
            
            if ! validate_ip "$new_ip"; then
                log_error "æ— æ•ˆçš„ IP åœ°å€æ ¼å¼: $new_ip"
                continue
            fi
            
            ALLOWED_IPS+=("$new_ip")
            log_info "âœ… å·²æ·»åŠ : $new_ip"
        done
    fi
    
    echo ""
    log_step "æ­¥éª¤ 3/3: ç¡®è®¤é…ç½®"
    echo ""
    echo -e "${CYAN}é…ç½®æ‘˜è¦:${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "  ${YELLOW}æœ¬æœº (SNAT æœåŠ¡å™¨):${NC}"
    echo "    ens20 IP: $LOCAL_ENS20_IP"
    echo "    ens18 (å…¬ç½‘å‡ºå£): $(get_external_ip 2>/dev/null || echo 'å¾…æ£€æµ‹')"
    echo ""
    echo -e "  ${YELLOW}è¿œç¨‹ IX æœåŠ¡å™¨:${NC}"
    echo "    IP: $IX_SERVER_IP"
    echo "    ens20 ç½‘å…³å°†è®¾ç½®ä¸º: ${GREEN}$LOCAL_ENS20_IP${NC} (æœ¬æœº)"
    echo "    DNS: 1.1.1.1, 8.8.8.8"
    echo "    å°†é…ç½®ç­–ç•¥è·¯ç”±å¹¶æŒä¹…åŒ–"
    echo ""
    echo -e "  ${YELLOW}å…è®¸è½¬å‘çš„ IP åˆ—è¡¨:${NC}"
    for ip in "${ALLOWED_IPS[@]}"; do
        if [ "$ip" == "$IX_SERVER_IP" ]; then
            echo "    â€¢ $ip ${GREEN}(IX Server)${NC}"
        else
            echo "    â€¢ $ip"
        fi
    done
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    
    read -p "ç¡®è®¤å¼€å§‹é…ç½®ï¼Ÿ(yes/no) [yes]: " confirm
    confirm=${confirm:-yes}
    
    if [ "$confirm" != "yes" ]; then
        log_warn "é…ç½®å·²å–æ¶ˆ"
        exit 0
    fi
    
    echo ""
    print_header "å¼€å§‹æ‰§è¡Œé…ç½®"
    
    echo ""
    log_step "ã€é˜¶æ®µ 1/2ã€‘é…ç½®æœ¬åœ° SNAT..."
    echo ""
    init_snat
    save_iptables
    
    show_snat_summary
    
    echo ""
    log_step "ã€é˜¶æ®µ 2/2ã€‘é…ç½®è¿œç¨‹ç­–ç•¥è·¯ç”±..."
    echo ""
    
    if configure_remote_policy_routing "$IX_SERVER_IP" "$IX_SERVER_PASSWORD" "$LOCAL_ENS20_IP"; then
        print_header "ğŸ‰ å…¨éƒ¨é…ç½®å®Œæˆï¼"
        echo ""
        echo -e "${GREEN}âœ… æœ¬åœ° SNAT é…ç½®æˆåŠŸ${NC}"
        echo -e "${GREEN}âœ… è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®æˆåŠŸ${NC}"
        echo -e "${GREEN}âœ… æ‰€æœ‰é…ç½®å·²æŒä¹…åŒ–${NC}"
        echo ""
    else
        echo ""
        log_warn "æœ¬åœ° SNAT é…ç½®æˆåŠŸï¼Œä½†è¿œç¨‹ç­–ç•¥è·¯ç”±é…ç½®å¤±è´¥"
    fi
}

###########################################
# å…¶ä»–å¤„ç†å‡½æ•°ï¼ˆä¿æŒä¸å˜ï¼‰
###########################################

handle_add_ip() {
    check_root
    local ip="$1"
    
    if [ -z "$ip" ]; then
        log_error "è¯·æŒ‡å®š IP åœ°å€"
        echo "ç”¨æ³•: $0 add <IPåœ°å€>"
        exit 1
    fi
    
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    add_allowed_ip "$ip"
    save_iptables
}

handle_del_ip() {
    check_root
    local ip="$1"
    
    if [ -z "$ip" ]; then
        log_error "è¯·æŒ‡å®š IP åœ°å€"
        echo "ç”¨æ³•: $0 del <IPåœ°å€>"
        exit 1
    fi
    
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    if iptables -C FORWARD -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT 2>/dev/null; then
        iptables -D FORWARD -s "$ip" -i "$INTERNAL_IF" -o "$EXTERNAL_IF" -j ACCEPT
        log_info "âœ… å·²ä»å…è®¸åˆ—è¡¨åˆ é™¤ $ip"
        save_iptables
    else
        log_warn "IP $ip ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­"
    fi
}

handle_list() {
    check_interface "$INTERNAL_IF"
    check_interface "$EXTERNAL_IF"
    
    print_header "å…è®¸è½¬å‘çš„ IP åˆ—è¡¨"
    
    INTERNAL_NETWORK=$(get_internal_network)
    EXTERNAL_IP=$(get_external_ip)
    LOCAL_ENS20_IP=$(get_internal_ip)
    
    echo -e "${BLUE}æœ¬æœºé…ç½®:${NC}"
    echo -e "  â€¢ å†…ç½‘æ¥å£: $INTERNAL_IF ($LOCAL_ENS20_IP)"
    echo -e "  â€¢ å¤–ç½‘æ¥å£: $EXTERNAL_IF ($EXTERNAL_IP)"
    echo -e "  â€¢ ç½‘æ®µ: $INTERNAL_NETWORK"
    echo ""
    
    local rules=$(iptables -L FORWARD -n -v --line-numbers | grep "$EXTERNAL_IF" | grep ACCEPT | grep -v "state RELATED,ESTABLISHED")
    
    if [ -z "$rules" ]; then
        log_warn "å½“å‰æ²¡æœ‰é…ç½®å…è®¸è½¬å‘çš„ IP"
    else
        echo -e "${GREEN}åºå·  æ•°æ®åŒ…  å­—èŠ‚æ•°    æºåœ°å€${NC}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "$rules" | awk '{printf "%-6s%-8s%-10s%s\n", $1, $2, $3, $8}'
    fi
    
    echo ""
}

show_help() {
    cat << EOF
${GREEN}SNAT + ç­–ç•¥è·¯ç”± ä¸€ä½“åŒ–é…ç½®è„šæœ¬ (ä¿®å¤ç‰ˆ)${NC}

${YELLOW}ç”¨æ³•:${NC}
    $0                    # è¿è¡Œäº¤äº’å¼é…ç½®å‘å¯¼
    $0 <command> [args]   # æ‰§è¡Œå•ç‹¬å‘½ä»¤

${YELLOW}å¯ç”¨å‘½ä»¤:${NC}
    ${BLUE}setup${NC}               è¿è¡Œå®Œæ•´é…ç½®å‘å¯¼ï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰
    ${BLUE}add${NC} <IP>           æ·»åŠ å…è®¸è½¬å‘çš„ IP åœ°å€
    ${BLUE}del${NC} <IP>           åˆ é™¤å…è®¸è½¬å‘çš„ IP åœ°å€
    ${BLUE}list${NC}                åˆ—å‡ºæ‰€æœ‰å…è®¸è½¬å‘çš„ IP
    ${BLUE}clean${NC}               æ¸…ç©ºç­–ç•¥è·¯ç”±é…ç½®
    ${BLUE}test-ssh${NC} <IP>      æµ‹è¯• SSH è¿æ¥ï¼ˆè¯Šæ–­æ¨¡å¼ï¼‰
    ${BLUE}help${NC}                æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

${YELLOW}ç¤ºä¾‹:${NC}
    $0                    # è¿è¡Œé…ç½®å‘å¯¼
    $0 add 192.168.1.105  # æ·»åŠ  IP
    $0 list               # æŸ¥çœ‹åˆ—è¡¨
    $0 clean              # æ¸…ç©ºé…ç½®
    $0 test-ssh 1.2.3.4   # æµ‹è¯• SSH

${YELLOW}å‰ç½®è¦æ±‚:${NC}
    â€¢ root æƒé™
    â€¢ sshpass: apt install sshpass
EOF
}

###########################################
# ä¸»å‡½æ•°
###########################################

main() {
    case "${1:-setup}" in
        setup|init|config|configure)
            interactive_setup
            ;;
        add)
            handle_add_ip "$2"
            ;;
        del|delete|remove)
            handle_del_ip "$2"
            ;;
        list|ls|show)
            handle_list
            ;;
        clean|clear|reset)
            clean_policy_routing
            ;;
        test-ssh)
            if [ -z "$2" ]; then
                echo "ç”¨æ³•: $0 test-ssh <IPåœ°å€> [ç«¯å£] [ç”¨æˆ·å]"
                exit 1
            fi
            read -s -p "è¯·è¾“å…¥ SSH å¯†ç : " password
            echo ""
            test_ssh_connection "$2" "$password" "${3:-22}" "${4:-root}"
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            if [ -z "$1" ]; then
                interactive_setup
            else
                log_error "æœªçŸ¥å‘½ä»¤: $1"
                echo ""
                show_help
                exit 1
            fi
            ;;
    esac
}

main "$@"
